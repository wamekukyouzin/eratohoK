;コマンドの自動選択処理

;-------------------------------------------------
;キャラARG:0が自動実行コマンドを実行可能かどうかを判定
;-------------------------------------------------
@IS_AUTOSELECT(ARG:0)
#FUNCTION
SIF ARG:0 != MASTER && CFLAG:(ARG:0):調教参加フラグ && !TCVAR:(ARG:0):51 && !TCVAR:(ARG:0):52 && !TCVAR:(ARG:0):53 && ABL:(ARG:0):性知識 > 0
	RETURNF 1
RETURNF 0

;-------------------------------------------------
;コマンドの自動実行の処理
;-------------------------------------------------
@COM_AUTOSELECT
;コマンドの実行優先度(この値に比例した確率でコマンドが選ばれる)
;0～999は主人公がターゲット、1000～1999は主人公がプレイヤー、2000～2999は主人公を放置
#DIM COM_PRIORITY, 3000

;コマンド実行優先度の計算に使う一時変数
#DIM COM_PRIORITY_SUM, 10

;カテゴリの選択優先度(この値に比例した確率でコマンドの傾向が決まる)
#DIM CATEGORY_PRIORITY, 10

;各コマンドの分類
#DIM COM_CATEGORY, 3000

;無限ループ回避用
#DIM LOOP_CNT

VARSET LOOP_CNT

;選択可能なコマンドが最後の最後までなかった場合、ここに飛んでくる
$RESTARTED

LOOP_CNT ++

VARSET CATEGORY_PRIORITY, 0
VARSET COM_PRIORITY, 0
VARSET COM_PRIORITY_SUM, 0
VARSET COM_CATEGORY, 0
VARSET LOCAL, 0


;まずは中心となるキャラをランダムに1名選ぶ(主導権基準値によって確率に差異があっても良い？)
;そのキャラの好みを考慮してまずコマンドの分類を、次に実際のコマンド番号を決定
;複数のキャラが可能なコマンドは複数のキャラで行うこともある
;基本はマゾよりサドが優先される

;愛撫する
;愛撫させる
;性交する(挿入)
;性交する(被挿入)
;いぢめる(加虐)
;いぢめる(羞恥)

;●各コマンドのカテゴリを設定
;カテゴリ:愛撫する
COM_CATEGORY:0 = 1
COM_CATEGORY:1 = 1
COM_CATEGORY:2 = 1
COM_CATEGORY:3 = 1
COM_CATEGORY:4 = 1
COM_CATEGORY:5 = 1
COM_CATEGORY:6 = 1
COM_CATEGORY:7 = 1
COM_CATEGORY:8 = 1
COM_CATEGORY:10 = 1
COM_CATEGORY:11 = 1
COM_CATEGORY:12 = 1
COM_CATEGORY:13 = 1
COM_CATEGORY:14 = 1
COM_CATEGORY:15 = 1
COM_CATEGORY:16 = 1
COM_CATEGORY:17 = 1
COM_CATEGORY:20 = 1
COM_CATEGORY:60 = 1
COM_CATEGORY:61 = 1
COM_CATEGORY:62 = 1
COM_CATEGORY:63 = 1
COM_CATEGORY:64 = 1
COM_CATEGORY:65 = 1
COM_CATEGORY:66 = 1
COM_CATEGORY:71 = 1
COM_CATEGORY:72 = 1
COM_CATEGORY:103 = 1
COM_CATEGORY:104 = 1
COM_CATEGORY:106 = 1
COM_CATEGORY:107 = 1
COM_CATEGORY:1090 = 1
COM_CATEGORY:1104 = 1
;カテゴリ:愛撫させる
COM_CATEGORY:90 = 2
COM_CATEGORY:101 = 2
COM_CATEGORY:102 = 2
COM_CATEGORY:105 = 2
COM_CATEGORY:1000 = 2
COM_CATEGORY:1001 = 2
COM_CATEGORY:1002 = 2
COM_CATEGORY:1003 = 2
COM_CATEGORY:1004 = 2
COM_CATEGORY:1005 = 2
COM_CATEGORY:1006 = 2
COM_CATEGORY:1007 = 2
COM_CATEGORY:1010 = 2
COM_CATEGORY:1011 = 2
COM_CATEGORY:1012 = 2
COM_CATEGORY:1013 = 2
COM_CATEGORY:1014 = 2
COM_CATEGORY:1015 = 2
COM_CATEGORY:1016 = 2
COM_CATEGORY:1018 = 2
COM_CATEGORY:1020 = 2
COM_CATEGORY:1060 = 2
COM_CATEGORY:1061 = 2
COM_CATEGORY:1062 = 2
COM_CATEGORY:1063 = 2
COM_CATEGORY:1064 = 2
COM_CATEGORY:1065 = 2
COM_CATEGORY:1066 = 2
COM_CATEGORY:1071 = 2
COM_CATEGORY:1072 = 2
COM_CATEGORY:1081 = 2
COM_CATEGORY:1082 = 2
COM_CATEGORY:1083 = 2
COM_CATEGORY:1084 = 2
COM_CATEGORY:1085 = 2
COM_CATEGORY:1086 = 2
COM_CATEGORY:1087 = 2
COM_CATEGORY:1088 = 2
COM_CATEGORY:1089 = 2
COM_CATEGORY:1103 = 2
COM_CATEGORY:1106 = 2
COM_CATEGORY:1107 = 2
COM_CATEGORY:1140 = 2
COM_CATEGORY:1141 = 2
COM_CATEGORY:1142 = 2
;カテゴリ:性交
COM_CATEGORY:21 = 3
COM_CATEGORY:22 = 3
COM_CATEGORY:30 = 3
COM_CATEGORY:31 = 3
COM_CATEGORY:32 = 3
COM_CATEGORY:33 = 3
COM_CATEGORY:34 = 3
COM_CATEGORY:35 = 3
COM_CATEGORY:36 = 3
COM_CATEGORY:37 = 3
COM_CATEGORY:38 = 3
COM_CATEGORY:40 = 3
COM_CATEGORY:41 = 3
COM_CATEGORY:42 = 3
COM_CATEGORY:43 = 3
COM_CATEGORY:44 = 3
COM_CATEGORY:45 = 3
COM_CATEGORY:46 = 3
COM_CATEGORY:50 = 3
COM_CATEGORY:55 = 3
COM_CATEGORY:56 = 3
COM_CATEGORY:70 = 3
COM_CATEGORY:72 = 3
COM_CATEGORY:75 = 3
COM_CATEGORY:1075 = 3
COM_CATEGORY:1021 = 3
COM_CATEGORY:1022 = 3
COM_CATEGORY:1030 = 3
COM_CATEGORY:1031 = 3
COM_CATEGORY:1032 = 3
COM_CATEGORY:1033 = 3
COM_CATEGORY:1034 = 3
COM_CATEGORY:1035 = 3
COM_CATEGORY:1037 = 3
COM_CATEGORY:1038 = 3
COM_CATEGORY:1040 = 3
COM_CATEGORY:1041 = 3
COM_CATEGORY:1042 = 3
COM_CATEGORY:1043 = 3
COM_CATEGORY:1044 = 3
COM_CATEGORY:1045 = 3
COM_CATEGORY:1050 = 3
COM_CATEGORY:1055 = 3
COM_CATEGORY:1056 = 3
COM_CATEGORY:1070 = 3
COM_CATEGORY:1072 = 3
;カテゴリ:いぢめる加虐
COM_CATEGORY:74 = 4
COM_CATEGORY:80 = 4
COM_CATEGORY:81 = 4
COM_CATEGORY:82 = 4
COM_CATEGORY:83 = 4
COM_CATEGORY:84 = 4
COM_CATEGORY:85 = 4
COM_CATEGORY:86 = 4
COM_CATEGORY:87 = 4
COM_CATEGORY:88 = 4
COM_CATEGORY:89 = 4
COM_CATEGORY:1091 = 4
COM_CATEGORY:92 = 4
COM_CATEGORY:93 = 4
COM_CATEGORY:94 = 4
COM_CATEGORY:1094 = 4
COM_CATEGORY:95 = 4
COM_CATEGORY:96 = 4
COM_CATEGORY:97 = 4
;カテゴリ:いぢめる羞恥
COM_CATEGORY:100 = 5
COM_CATEGORY:112 = 5
COM_CATEGORY:114 = 5
COM_CATEGORY:130 = 5
COM_CATEGORY:131 = 5
COM_CATEGORY:132 = 5
COM_CATEGORY:140 = 5
COM_CATEGORY:141 = 5
COM_CATEGORY:142 = 5
COM_CATEGORY:150 = 5
COM_CATEGORY:151 = 5
COM_CATEGORY:1100 = 5
COM_CATEGORY:1101 = 5
COM_CATEGORY:1102 = 5
COM_CATEGORY:1104 = 5
COM_CATEGORY:1110 = 5
COM_CATEGORY:1111 = 5
COM_CATEGORY:1130 = 5
COM_CATEGORY:1131 = 5
COM_CATEGORY:1132 = 5
COM_CATEGORY:1150 = 5
COM_CATEGORY:1151 = 5
;カテゴリ:触手で愛撫する
COM_CATEGORY:200 = 6
COM_CATEGORY:201 = 6
COM_CATEGORY:202 = 6
COM_CATEGORY:203 = 6
COM_CATEGORY:204 = 6
COM_CATEGORY:205 = 6
COM_CATEGORY:206 = 6
COM_CATEGORY:207 = 6
COM_CATEGORY:208 = 6
COM_CATEGORY:210 = 6
COM_CATEGORY:211 = 6
COM_CATEGORY:212 = 6
COM_CATEGORY:213 = 6
;カテゴリ:触手で愛撫させる
COM_CATEGORY:1200 = 7
COM_CATEGORY:1201 = 7
COM_CATEGORY:1202 = 7
COM_CATEGORY:1203 = 7
COM_CATEGORY:1204 = 7
COM_CATEGORY:1205 = 7
COM_CATEGORY:1206 = 7
COM_CATEGORY:1207 = 7
COM_CATEGORY:1208 = 7
COM_CATEGORY:1210 = 7
COM_CATEGORY:1211 = 7
COM_CATEGORY:1212 = 7
COM_CATEGORY:1213 = 7
;カテゴリ:説得
COM_CATEGORY:298 = 8

IF FLAG:調教モード == 7
	CALL COM_AUTOSELECT_DECIDE_PLAYER_IAN
	SIF RESULT == -1
		GOTO SKIPPED
	LOCAL:5 = RESULT
	CALL COM_AUTOSELECT_DECIDE_TARGET_IAN(LOCAL:5)
	LOCAL:98 = RESULT
ELSE
	CALL COM_AUTOSELECT_DECIDE_PLAYER
	SIF RESULT == -1
		GOTO SKIPPED
	LOCAL:5 = RESULT
	CALL COM_AUTOSELECT_DECIDE_TARGET(LOCAL:5)
	LOCAL:98 = RESULT
ENDIF

$CHOOSE_END

;●性交を行う場合に、どのコマンドを選ぶか事前に決定しておく
;性別と経験に応じて可能なものからランダムに選択
LOCAL:6 = -1
LOCAL:7 = IS_INSERT_MUTUAL(LOCAL:5, LOCAL:98)
;挿入中なら同じ挿入状態を継続
IF LOCAL:7
	SELECTCASE LOCAL:7
		CASE 1
			LOCAL:6 = 2
		CASE 2
			LOCAL:6 = 3
		CASE 3
			LOCAL:6 = 0
		CASE 4
			LOCAL:6 = 1
	ENDSELECT

ELSE
	IF PENIS(LOCAL:98) || ITEM:ペニスバンド || ITEM:A_ペニスバンド
		IF VAGINA(LOCAL:5)
			LOCAL:10 = MAX(EXP:(LOCAL:5):Ｖ性交経験 + 10 + ABL:(LOCAL:5):欲望 / 2 + ABL:(LOCAL:5):Ｖ感 * 2, 0)
		ENDIF
		LOCAL:11 = MAX(EXP:(LOCAL:5):Ａ性交経験 + 5 + GET_PERVERSION_RANK(LOCAL:5) / 3 + ABL:(LOCAL:5):Ａ感, 0)
		SIF IS_MALE(LOCAL:5)
			LOCAL:11 /= 2
	ENDIF
	IF PENIS(LOCAL:5) || ITEM:ペニスバンド || ITEM:A_ペニスバンド
		IF VAGINA(LOCAL:98)
			LOCAL:12 = MAX(EXP:(LOCAL:5):Ｖ挿入経験 + 10 + (PENIS(LOCAL:5) * ABL:(LOCAL:5):射精) + ABL:(LOCAL:5):欲望 / 2 + ABL:(LOCAL:98):Ｖ感 * 2, 0)
		ENDIF
		LOCAL:13 = MAX(EXP:(LOCAL:5):Ａ挿入経験 + (PENIS(LOCAL:5) * ABL:(LOCAL:5):射精) + GET_PERVERSION_RANK(LOCAL:5) / 3 + ABL:(LOCAL:98):Ａ感, 0)
		SIF IS_MALE(LOCAL:98)
			LOCAL:13 /= 2
	ENDIF
	IF !PENIS(LOCAL:98) && !PENIS(LOCAL:5)
		LOCAL:14 = MAX(ABL:(LOCAL:5):レズ * ABL:(LOCAL:5):レズ * 5, 0)
	ENDIF

	IF VAGINA(LOCAL:98)
		IF IS_INSERT_SINGLE(LOCAL:98, "Ｖ") && !IS_INSERT_SINGLE(LOCAL:98, "Ａ")
			TIMES LOCAL:12, 0.00
			TIMES LOCAL:13, 10.00
		ENDIF
		IF IS_INSERT_SINGLE(LOCAL:98, "Ａ") && !IS_INSERT_SINGLE(LOCAL:98, "Ｖ")
			TIMES LOCAL:12, 10.00
			TIMES LOCAL:13, 0.00
		ENDIF
	ENDIF

	;捕虜逆調教で竿を弄らない設定の場合
	IF FLAG:調教モード == 5 && CONFIG:8 == 1
		;Ｖ→ＰとＡ→Ｐを禁止
		LOCAL:10 = 0
		LOCAL:11 = 0
	ENDIF

	;挿入関係が予約されているなら条件に合わないものを排除
	IF TFLAG:30 == 3
		LOCAL:10 = 0
		LOCAL:11 = 0
	ELSEIF TFLAG:30 == 13
		LOCAL:12 = 0
		LOCAL:13 = 0
	ENDIF

	LOCAL:15 = LOCAL:10 + LOCAL:11 + LOCAL:12 + LOCAL:13 + LOCAL:14
	IF LOCAL:15 >= 1
		LOCAL:16 = RAND:(LOCAL:15)
		FOR LOCAL:0, 10, 15
			LOCAL:16 -= LOCAL:(LOCAL:0)
			IF LOCAL:16 < 0
				LOCAL:6 = LOCAL:0 - 10
				BREAK
			ENDIF
		NEXT
	ENDIF
ENDIF

;●各カテゴリの選択確率を設定
;◆愛撫したい欲求
;捕虜調教
IF FLAG:調教モード == 5
	CATEGORY_PRIORITY:1 = 10
	CATEGORY_PRIORITY:1 += GET_INITIATIVE_U_RANK(LOCAL:5) * 2
	CATEGORY_PRIORITY:1 -= GET_PERVERSION_RANK(LOCAL:5) / 2
	CATEGORY_PRIORITY:1 += ABL:(LOCAL:5):奉仕
	CATEGORY_PRIORITY:1 += (TALENT:(LOCAL:5):献身的 != 0) * 5 + (TALENT:(LOCAL:5):好奇心 != 0) * 2
;通常
ELSE
	CATEGORY_PRIORITY:1 = 7
	CATEGORY_PRIORITY:1 += GET_INITIATIVE_U_RANK(LOCAL:5) * 3 / 2
	CATEGORY_PRIORITY:1 -= GET_PERVERSION_RANK(LOCAL:5) / 2
	CATEGORY_PRIORITY:1 += ABL:(LOCAL:5):奉仕 * 3
	CATEGORY_PRIORITY:1 += (TALENT:(LOCAL:5):献身的 != 0) * 5 + (TALENT:(LOCAL:5):好奇心 != 0) * 2
ENDIF

;◆愛撫してほしい欲求
;捕虜調教
IF FLAG:調教モード == 5
	CATEGORY_PRIORITY:2 = 5
	CATEGORY_PRIORITY:2 -= GET_INITIATIVE_U_RANK(LOCAL:5)
	CATEGORY_PRIORITY:2 += ABL:(LOCAL:5):欲望 / 2
	CATEGORY_PRIORITY:2 += -(TALENT:(LOCAL:5):献身的 != 0) * 5 + (TALENT:(LOCAL:5):快感に素直) * 4 - (TALENT:(LOCAL:5):快感の否定) * 5
;通常
ELSE
	CATEGORY_PRIORITY:2 = 5
	CATEGORY_PRIORITY:2 -= GET_INITIATIVE_U_RANK(LOCAL:5) / 2
	CATEGORY_PRIORITY:2 -= GET_PERVERSION_RANK(LOCAL:5) / 2
	CATEGORY_PRIORITY:2 += ABL:(LOCAL:5):欲望
	CATEGORY_PRIORITY:2 += -(TALENT:(LOCAL:5):献身的 != 0) * 5 + (TALENT:(LOCAL:5):快感に素直) * 4 - (TALENT:(LOCAL:5):快感の否定) * 5
ENDIF

;◆性交したい欲求
CATEGORY_PRIORITY:3 = 0
CATEGORY_PRIORITY:3 += ABL:(LOCAL:5):欲望
CATEGORY_PRIORITY:3 += ABL:(LOCAL:5):性交 / 2
CATEGORY_PRIORITY:3 += GET_PALAMLV(PALAM:(LOCAL:5):欲情)
CATEGORY_PRIORITY:3 += -(TALENT:(LOCAL:5):大人しい != 0) * 2 - (TALENT:(LOCAL:5):プライド高い != 0) * 5 + (TALENT:(LOCAL:5):プライド低い != 0) * 2
CATEGORY_PRIORITY:3 += -(TALENT:(LOCAL:5):保守的 != 0) * 2 + (TALENT:(LOCAL:5):快感に素直) * 4 - (TALENT:(LOCAL:5):快感の否定) * 6
CATEGORY_PRIORITY:3 += IS_FALLEN_TO_SP_COUNTRY(LOCAL:5)* 8
SELECTCASE LOCAL:6
	CASE -1
		CATEGORY_PRIORITY:3 = 0
	CASE 0
		IF PENIS(LOCAL:5)
			CATEGORY_PRIORITY:3 += ABL:(LOCAL:5):射精
		ELSE
			CATEGORY_PRIORITY:3 += ABL:(LOCAL:5):Ｃ感
		ENDIF
	CASE 1
		IF PENIS(LOCAL:5)
			CATEGORY_PRIORITY:3 += ABL:(LOCAL:5):射精
		ELSE
			CATEGORY_PRIORITY:3 += ABL:(LOCAL:5):Ｃ感
		ENDIF
		CATEGORY_PRIORITY:3 += (TALENT:(LOCAL:98):美尻 || TALENT:(LOCAL:98):豊尻) * 3
	CASE 2
		CATEGORY_PRIORITY:3 += ABL:(LOCAL:5):Ｖ感
	CASE 3
		CATEGORY_PRIORITY:3 += ABL:(LOCAL:5):Ａ感
		CATEGORY_PRIORITY:3 += (TALENT:(LOCAL:5):美尻 || TALENT:(LOCAL:5):豊尻) * 2
	CASE 4
		CATEGORY_PRIORITY:3 += ABL:(LOCAL:5):レズ
ENDSELECT
IF LOCAL:7
	TIMES CATEGORY_PRIORITY:3, 2.00
ELSEIF IS_INSERT_SINGLE(LOCAL:98, "全")
	TIMES CATEGORY_PRIORITY:3, 2.00
ENDIF

;◆いぢめたい欲求(加虐)
CATEGORY_PRIORITY:4 = 0
IF CFLAG:(LOCAL:5):所属 == CFLAG:(LOCAL:98):所属
	CATEGORY_PRIORITY:4 += GET_INITIATIVE_U_RANK(LOCAL:5)
	CATEGORY_PRIORITY:4 += GET_PERVERSION_RANK(LOCAL:5) * 2
ELSE
	CATEGORY_PRIORITY:4 += GET_INITIATIVE_U_RANK(LOCAL:5) * 2
	CATEGORY_PRIORITY:4 += GET_PERVERSION_RANK(LOCAL:5) * 3
ENDIF

IF CATEGORY_PRIORITY:4 >= 1
	CATEGORY_PRIORITY:4 += ABL:(LOCAL:5):奉仕
	CATEGORY_PRIORITY:4 += (TALENT:(LOCAL:5):好奇心 != 0) * 2 - (TALENT:(LOCAL:5):保守的 != 0) * 2
ENDIF

;◆いぢめたい欲求(羞恥)
;捕虜調教
IF FLAG:調教モード == 5
	CATEGORY_PRIORITY:5 = 1
	CATEGORY_PRIORITY:5 += GET_INITIATIVE_U_RANK(LOCAL:5) * 2
	CATEGORY_PRIORITY:5 += GET_PERVERSION_RANK(LOCAL:5)
	CATEGORY_PRIORITY:5 += (TALENT:(LOCAL:5):小悪魔 != 0) * 3
	CATEGORY_PRIORITY:5 += ABL:(LOCAL:5):露出
	CATEGORY_PRIORITY:5 += (TALENT:(LOCAL:5):好奇心 != 0) * 1 - (TALENT:(LOCAL:5):保守的 != 0) * 2 - (TALENT:(LOCAL:5):献身的 != 0) * 3
	IF TFLAG:55 < 7 || TFLAG:55 > 15
		CATEGORY_PRIORITY:5 = 0
	ENDIF
;通常
ELSE
	CATEGORY_PRIORITY:5 = 0
	CATEGORY_PRIORITY:5 += GET_INITIATIVE_U_RANK(LOCAL:5) * 2
	CATEGORY_PRIORITY:5 += GET_PERVERSION_RANK(LOCAL:5)
	CATEGORY_PRIORITY:5 += (TALENT:(LOCAL:5):小悪魔 != 0) * 3
	IF CATEGORY_PRIORITY:5 >= 1
		CATEGORY_PRIORITY:5 += ABL:(LOCAL:5):露出
		CATEGORY_PRIORITY:5 += (TALENT:(LOCAL:5):好奇心 != 0) * 1 - (TALENT:(LOCAL:5):保守的 != 0) * 2 - (TALENT:(LOCAL:5):献身的 != 0) * 3
	ENDIF
	IF TFLAG:55 < 7 || TFLAG:55 > 15
		CATEGORY_PRIORITY:5 = 0
	ENDIF
ENDIF

;◆触手で愛撫したい欲求
;捕虜調教
IF FLAG:調教モード == 5
	CATEGORY_PRIORITY:6 = 0
;通常
ELSE
	CATEGORY_PRIORITY:6 = 0
ENDIF
IF ABL:(LOCAL:5):触手 >= 2 && TALENT:(LOCAL:5):妖術知識
	CATEGORY_PRIORITY:6 += GET_INITIATIVE_U_RANK(LOCAL:5)
	CATEGORY_PRIORITY:6 += ABL:(LOCAL:5):触手 * 2 - 8 + GET_PERVERSION_RANK(LOCAL:5)
	CATEGORY_PRIORITY:6 += (TALENT:(LOCAL:5):好奇心 != 0) * 3
	CATEGORY_PRIORITY:6 += IS_EQUIP_PLAYER(LOCAL:5, 200) * 6
ENDIF

;◆触手で愛撫してほしい欲求
;捕虜調教
IF FLAG:調教モード == 5
	CATEGORY_PRIORITY:7 = -15
;通常
ELSE
	CATEGORY_PRIORITY:7 = 0
ENDIF
IF ABL:(LOCAL:5):触手 >= 2 && TALENT:(LOCAL:98):妖術知識
	CATEGORY_PRIORITY:7 -= GET_INITIATIVE_U_RANK(LOCAL:5)
	CATEGORY_PRIORITY:7 += ABL:(LOCAL:5):触手 * 2 - 8 + GET_PERVERSION_RANK(LOCAL:5)
	CATEGORY_PRIORITY:7 += -(TALENT:(LOCAL:5):献身的 != 0) * 5 + (TALENT:(LOCAL:5):好奇心 != 0) * 3 + (TALENT:(LOCAL:5):快感に素直) * 4 - (TALENT:(LOCAL:5):快感の否定) * 5
ENDIF

;◆説得
LOCAL:1 = 4
FOR LOCAL:0, 0, 8
	LOCAL:1 += MAX(CATEGORY_PRIORITY:(LOCAL:0), 0)
NEXT
CATEGORY_PRIORITY:8 = LIMIT((FLAG:勧誘経過期間 - 1) * 5 - (TFLAG:55 < 5) * 10, 0, 90)
CATEGORY_PRIORITY:8 = LOCAL:1 * CATEGORY_PRIORITY:8 / (100 - CATEGORY_PRIORITY:8)

;各カテゴリの優先度を最低値以上にする
CATEGORY_PRIORITY:1 = MAX(CATEGORY_PRIORITY:1, 2)
CATEGORY_PRIORITY:2 = MAX(CATEGORY_PRIORITY:2, 2)
CATEGORY_PRIORITY:3 = MAX(CATEGORY_PRIORITY:3, 0)
CATEGORY_PRIORITY:4 = MAX(CATEGORY_PRIORITY:4, 0)
CATEGORY_PRIORITY:5 = MAX(CATEGORY_PRIORITY:5, 0)
CATEGORY_PRIORITY:6 = MAX(CATEGORY_PRIORITY:6, 0)
CATEGORY_PRIORITY:7 = MAX(CATEGORY_PRIORITY:7, 0)
CATEGORY_PRIORITY:8 = MAX(CATEGORY_PRIORITY:8, 0)

;カテゴリの予約があった場合、そのカテゴリの選択率を大幅に上昇
IF TFLAG:30 >= 1
	CATEGORY_PRIORITY:(TFLAG:30 % 10) += 1000000
	FOR LOCAL, 0, 3000
		IF COM_CATEGORY:LOCAL == TFLAG:30 % 10
			COM_PRIORITY:LOCAL = MAX(COM_PRIORITY:LOCAL, 1)
		ENDIF
	NEXT
ENDIF

;★
;各カテゴリ選択率の表示
;FOR LOCAL:0, 0, 10
;	PRINTFORML {LOCAL:0}:{CATEGORY_PRIORITY:(LOCAL:0)}
;NEXT

;●各コマンドの基本実行確率を設定
;愛撫
COM_PRIORITY:0 += 3 + MIN(ABL:(LOCAL:98):Ｃ感 / 2 , 5) + MIN(ABL:(LOCAL:98):Ｂ感, 5)
COM_PRIORITY:0 += MIN(ABL:(LOCAL:5):欲望 / 3 + ABL:(LOCAL:5):性技 / 2, 10)
;胸愛撫
COM_PRIORITY:1 += 3 + MIN(ABL:(LOCAL:98):Ｂ感, 5) + (TALENT:(LOCAL:5):素直 != 0) * 4 + (TALENT:(LOCAL:5):献身的 != 0) * 3
COM_PRIORITY:1 += MIN(ABL:(LOCAL:5):欲望 / 3 + ABL:(LOCAL:5):性技 / 2, 10)
COM_PRIORITY:1 += (TALENT:(LOCAL:5):大人しい != 0) * 4 + (TALENT:(LOCAL:5):臆病 != 0) * 4
COM_PRIORITY:1 += -(TALENT:(LOCAL:5):反抗的 != 0) * 3 - (TALENT:(LOCAL:5):生意気 != 0) * 3
COM_PRIORITY:1 += MIN(ABL:(LOCAL:98):Ｂ感 / 2 + 2, 30) + 1
COM_PRIORITY:1 += GET_BUSTSIZE_NUM(LOCAL:98) * 3
;クンニ
COM_PRIORITY:2 += 3 + MIN(ABL:(LOCAL:98):Ｃ感 / 2 + 2, 30) + 2 + ABL:(LOCAL:5):レズ
COM_PRIORITY:2 += MIN(ABL:(LOCAL:5):奉仕 / 2 + ABL:(LOCAL:5):性技 / 2, 10)
COM_PRIORITY:2 += (TALENT:(LOCAL:5):汚臭鈍感 != 0) * 2 - (TALENT:(LOCAL:5):汚臭敏感 != 0) * 7
;指挿入れ
COM_PRIORITY:3 += 3 + MIN(ABL:(LOCAL:98):Ｖ感, 5)
COM_PRIORITY:3 += MIN(ABL:(LOCAL:5):欲望 + ABL:(LOCAL:5):性技 / 2, 10)
COM_PRIORITY:3 += -(TALENT:(LOCAL:5):倒錯的 != 0) * 5 - GETBIT(TALENT:(LOCAL:5):淫乱系, 素質_淫乱_サド) * 2
COM_PRIORITY:3 += (TALENT:(LOCAL:5):献身的 != 0) * 3 + (TALENT:(LOCAL:5):素直 != 0) * 3
;アナル愛撫
COM_PRIORITY:4 += MIN(ABL:(LOCAL:98):Ａ感, 5) + GET_PERVERSION_RANK(LOCAL:5)
COM_PRIORITY:4 += MIN(ABL:(LOCAL:5):欲望 / 2 + ABL:(LOCAL:5):性技 / 4, 10)
COM_PRIORITY:4 += (TALENT:(LOCAL:5):倒錯的 != 0) * 7 + GETBIT(TALENT:(LOCAL:5):淫乱系, 素質_淫乱_サド) * 6 + (TALENT:(LOCAL:5):プライド高い != 0) * 4
COM_PRIORITY:4 += (TALENT:(LOCAL:5):生意気 != 0) * 6 + (TALENT:(LOCAL:5):反抗的 != 0) * 4
COM_PRIORITY:4 += -(TALENT:(LOCAL:5):素直 != 0) * 4 - (TALENT:(LOCAL:5):臆病 != 0) * 4
COM_PRIORITY:4 += (TALENT:(LOCAL:98):美尻 || TALENT:(LOCAL:98):豊尻) * 5
;アナル舐め
COM_PRIORITY:8 += MIN(ABL:(LOCAL:98):Ａ感 / 2 + 2, 30)
COM_PRIORITY:8 += MIN(ABL:(LOCAL:5):奉仕 / 3 + ABL:(LOCAL:5):性技 / 3, 10)
COM_PRIORITY:8 += (TALENT:(LOCAL:5):汚臭鈍感 != 0) * 2 - (TALENT:(LOCAL:5):汚臭敏感 != 0) * 7
COM_PRIORITY:8 += (TALENT:(LOCAL:98):美尻 || TALENT:(LOCAL:98):豊尻) * 5

;手コキ
COM_PRIORITY:10 += 5
;フェラ
COM_PRIORITY:11 += MIN((ABL:(LOCAL:5):奉仕 + ABL:(LOCAL:5):精愛 + ABL:(LOCAL:5):欲望 / 2), 50)
COM_PRIORITY:11 += (TALENT:(LOCAL:5):汚臭鈍感 != 0) * 2 - (TALENT:(LOCAL:5):汚臭敏感 != 0) * 7
;パイズリ
COM_PRIORITY:12 += MIN((ABL:(LOCAL:5):奉仕 * 2 + ABL:(LOCAL:5):精愛 / 2), 30) + GET_BUSTSIZE_NUM(LOCAL:5) * 10
COM_PRIORITY:12 += (TALENT:(LOCAL:5):汚臭鈍感 != 0) * 1 - (TALENT:(LOCAL:5):汚臭敏感 != 0) * 3

;素股
COM_PRIORITY:13 += MIN((ABL:(LOCAL:5):奉仕 * 2 + ABL:(LOCAL:5):精愛 / 2), 30)

;足コキ
COM_PRIORITY:14 += -5 + MIN(ABL:(LOCAL:5):奉仕 / 2, 10) + GET_PERVERSION_RANK(LOCAL:5) + GET_INITIATIVE_U_RANK(LOCAL:5) * 4
COM_PRIORITY:14 += (TALENT:(LOCAL:5):好奇心 != 0) * 4 - (TALENT:(LOCAL:5):保守的 != 0) * 6
COM_PRIORITY:14 += (TALENT:(LOCAL:5):プライド高い != 0) * 5 + (TALENT:(LOCAL:5):生意気 != 0) * 5 - (TALENT:(LOCAL:5):素直 != 0) * 4
COM_PRIORITY:14 += TALENT:(LOCAL:5):美脚 * 7
;尻コキ
COM_PRIORITY:15 += -15 + MIN(ABL:(LOCAL:5):奉仕 + ABL:(LOCAL:5):Ａ感, 20) + GET_PERVERSION_RANK(LOCAL:5) * 4
COM_PRIORITY:15 += (TALENT:(LOCAL:5):好奇心 != 0) * 4 - (TALENT:(LOCAL:5):保守的 != 0) * 10
COM_PRIORITY:15 += (TALENT:(LOCAL:5):恥薄い != 0) * 6 - (TALENT:(LOCAL:5):恥じらい != 0) * 8
COM_PRIORITY:4 += (TALENT:(LOCAL:5):美尻 || TALENT:(LOCAL:5):豊尻) * 6

;オナホコキ
COM_PRIORITY:16 += MIN(ABL:(LOCAL:5):奉仕 / 2, 10) + GET_PERVERSION_RANK(LOCAL:5) / 2 + GET_INITIATIVE_U_RANK(LOCAL:5) * 4
COM_PRIORITY:16 += (TALENT:(LOCAL:5):好奇心 != 0) * 4 - (TALENT:(LOCAL:5):保守的 != 0) * 6
COM_PRIORITY:16 += TALENT:(LOCAL:5):プライド高い * 5 + TALENT:(LOCAL:5):生意気 * 5 - (TALENT:(LOCAL:5):素直 != 0) * 4
COM_PRIORITY:16 += (TALENT:(LOCAL:5):Ｓ気質 || GETBIT(TALENT:(LOCAL:5):淫乱系, 素質_淫乱_サド)) * 7

;キス
IF CFLAG:(LOCAL:5):2 >= 1500 && (!TALENT:(LOCAL:5):キス未経験 || TALENT:(LOCAL:5):恋慕)
	COM_PRIORITY:20 += MIN(CFLAG:(LOCAL:5):2 / 100 - 8, 15) - GET_PERVERSION_RANK(LOCAL:5) * 4
	COM_PRIORITY:20 += (TALENT:(LOCAL:5):素直 != 0) * 5 - (TALENT:(LOCAL:5):反抗的 != 0) * 3 - (TALENT:(LOCAL:5):生意気 != 0) * 8
	COM_PRIORITY:20 += (TALENT:(LOCAL:5):貞操観念 != 0) * 6 - (TALENT:(LOCAL:5):貞操無頓着 != 0) * 6
	IF SEARCH_EQUIP(LOCAL:5, -1, -1) >= 0 || SEARCH_EQUIP(-1, LOCAL:5, -1) >= 0 || TFLAG:55 <= 2
	ELSEIF GROUPMATCH(FLAG:調教モード, 4, 5)
		COM_PRIORITY:20 -= 10
		TIMES COM_PRIORITY:20, 0.50
	ELSE
		COM_PRIORITY:20 -= 4
		TIMES COM_PRIORITY:20, 0.70
	ENDIF
ENDIF
;ローター
COM_PRIORITY:60 += -2 + GET_PERVERSION_RANK(LOCAL:5)
COM_PRIORITY:60 += MIN(ABL:(LOCAL:5):欲望 / 3, 5)
COM_PRIORITY:60 += (TALENT:(LOCAL:5):技師 != 0) * 6 + (TALENT:(LOCAL:5):好奇心 != 0) * 2 - (TALENT:(LOCAL:5):献身的 != 0) * 3
COM_PRIORITY:60 += (TALENT:(LOCAL:5):反抗的 != 0) * 2 + (TALENT:(LOCAL:5):プライド高い != 0) * 2
;バイブ
COM_PRIORITY:61 += GET_PERVERSION_RANK(LOCAL:5)
COM_PRIORITY:61 += MIN(ABL:(LOCAL:5):欲望 / 3, 5)
COM_PRIORITY:61 += (TALENT:(LOCAL:5):技師 != 0) * 6 + (TALENT:(LOCAL:5):好奇心 != 0) * 2 - (TALENT:(LOCAL:5):献身的 != 0) * 3
COM_PRIORITY:61 += (TALENT:(LOCAL:5):反抗的 != 0) * 2 + (TALENT:(LOCAL:5):プライド高い != 0) * 2
;アナルバイブ
COM_PRIORITY:62 += GET_PERVERSION_RANK(LOCAL:5)
COM_PRIORITY:61 += MIN(ABL:(LOCAL:5):欲望 / 4, 5)
COM_PRIORITY:62 += (TALENT:(LOCAL:5):技師 != 0) * 6 + (TALENT:(LOCAL:5):好奇心 != 0) * 2 - (TALENT:(LOCAL:5):献身的 != 0) * 3
COM_PRIORITY:62 += (TALENT:(LOCAL:5):反抗的 != 0) * 2 + (TALENT:(LOCAL:5):プライド高い != 0) * 2
COM_PRIORITY:62 += (TALENT:(LOCAL:98):美尻 || TALENT:(LOCAL:98):豊尻) * 6
;クリキャップ
COM_PRIORITY:63 += -4 + GET_PERVERSION_RANK(LOCAL:5)
COM_PRIORITY:63 += MIN(ABL:(LOCAL:5):欲望 / 2, 5)
COM_PRIORITY:63 += (TALENT:(LOCAL:5):技師 != 0) * 6 + (TALENT:(LOCAL:5):好奇心 != 0) * 2 - (TALENT:(LOCAL:5):献身的 != 0) * 3
COM_PRIORITY:63 += (TALENT:(LOCAL:5):反抗的 != 0) * 3 + (TALENT:(LOCAL:5):プライド高い != 0) * 2
;ニプルキャップ
COM_PRIORITY:64 += -4 + GET_PERVERSION_RANK(LOCAL:5)
COM_PRIORITY:64 += MIN(ABL:(LOCAL:5):欲望 / 2, 5)
COM_PRIORITY:64 += (TALENT:(LOCAL:5):技師 != 0) * 6 + (TALENT:(LOCAL:5):好奇心 != 0) * 2 - (TALENT:(LOCAL:5):献身的 != 0) * 3
COM_PRIORITY:64 += (TALENT:(LOCAL:5):反抗的 != 0) * 3 + (TALENT:(LOCAL:5):プライド高い != 0) * 2
;媚薬
IF TFLAG:55 <= TFLAG:56 / 2 && ITEM:A_媚薬
	COM_PRIORITY:71 += -3 + GET_PERVERSION_RANK(LOCAL:5) + GET_INITIATIVE_U_RANK(LOCAL:5)
	COM_PRIORITY:71 += (TALENT:(LOCAL:5):技師 != 0) * 3 + (TALENT:(LOCAL:5):好奇心 != 0) * 2 - (TALENT:(LOCAL:5):献身的 != 0) * 3
	COM_PRIORITY:71 += ABL:(LOCAL:5):欲望 + ABL:(LOCAL:5):性技
	COM_PRIORITY:71 += TFLAG:55 * 10
ENDIF
;排卵誘発剤
IF TFLAG:55 <= TFLAG:56 / 2 && CFLAG:(LOCAL:98):避妊薬残ターン == 0 && ITEM:A_排卵誘発剤 && GROUPMATCH(FLAG:調教モード, 4, 7)
	COM_PRIORITY:72 += -3 + GET_PERVERSION_RANK(LOCAL:5) + GET_INITIATIVE_U_RANK(LOCAL:5)
	COM_PRIORITY:72 += (TALENT:(LOCAL:5):技師 != 0) * 3 + (TALENT:(LOCAL:5):好奇心 != 0) * 2 - (TALENT:(LOCAL:5):献身的 != 0) * 3
	COM_PRIORITY:72 += ABL:(LOCAL:5):欲望 + ABL:(LOCAL:5):性技
	COM_PRIORITY:72 += TFLAG:55 * 10
ENDIF
;桃源香
IF TFLAG:55 <= TFLAG:56 / 2 && ITEM:A_桃源香
	COM_PRIORITY:71 += -3 + GET_PERVERSION_RANK(LOCAL:5) + GET_INITIATIVE_U_RANK(LOCAL:5)
	COM_PRIORITY:71 += (TALENT:(LOCAL:5):技師 != 0) * 3 + (TALENT:(LOCAL:5):好奇心 != 0) * 2 - (TALENT:(LOCAL:5):献身的 != 0) * 3
	COM_PRIORITY:71 += ABL:(LOCAL:5):欲望 + ABL:(LOCAL:5):性技
	COM_PRIORITY:71 += TFLAG:55 * 10
ENDIF

;ゴム
COM_PRIORITY:75 += ABL:(LOCAL:5):性知識 / 2 - ABL:(LOCAL:5):性交 / 3
COM_PRIORITY:75 += TALENT:(LOCAL:5):保守的 * 3 + TALENT:(LOCAL:5):貞操観念 * 5 + TALENT:(LOCAL:5):好奇心 * -4  + TALENT:(LOCAL:5):一線越えない * 5
COM_PRIORITY:75 += GETBIT(TALENT:(LOCAL:5):淫乱系, 素質_淫乱_淫乱) * -10 + TALENT:(LOCAL:98):特殊勢力素質 * -10
COM_PRIORITY:75 += GET_PERVERSION_RANK(LOCAL:5) * -1 + GET_INITIATIVE_U_RANK(LOCAL:5)
SIF GETBIT(TALENT:(LOCAL:5):淫乱系, 素質_淫乱_孕みたがり) || GETBIT(TALENT:(LOCAL:5):淫乱系, 素質_淫乱_生ハメ依存)
	COM_PRIORITY:75 = 0
;電気按摩
COM_PRIORITY:103 += -10 + MIN(ABL:(LOCAL:5):奉仕 / 2, 10) + GET_PERVERSION_RANK(LOCAL:5) * 2 + GET_INITIATIVE_U_RANK(LOCAL:5) * 5
COM_PRIORITY:103 += TALENT:(LOCAL:5):美脚 * 7

;足を舐める
COM_PRIORITY:104 += -7 + GET_PERVERSION_RANK(LOCAL:5) * 3 - GET_INITIATIVE_U_RANK(LOCAL:5)
COM_PRIORITY:104 += (TALENT:(LOCAL:5):汚臭鈍感 != 0) * 5 - (TALENT:(LOCAL:5):汚臭敏感 != 0) * 10
COM_PRIORITY:104 += (TALENT:(LOCAL:5):恥薄い != 0) * 5 - (TALENT:(LOCAL:5):恥じらい != 0) * 7 - (TALENT:(LOCAL:5):プライド高い != 0) * 7
COM_PRIORITY:104 += TALENT:(LOCAL:98):美脚 * 5

;イラマチオ
COM_PRIORITY:90 += -7 + MIN((ABL:(LOCAL:5):射精 + ABL:(LOCAL:5):欲望 / 2), 50) + GET_INITIATIVE_U_RANK(LOCAL:5) * GET_PERVERSION_RANK(LOCAL:5)
IF LOCAL:7
	IF PENIS(LOCAL:5)
		TIMES COM_PRIORITY:90, 0.30
	ELSE
		COM_PRIORITY:90 = 0
	ENDIF
ENDIF

IF VAGINA(LOCAL:5)
	;顔面騎乗
	COM_PRIORITY:101 += MIN(ABL:(LOCAL:5):Ｃ感 / 2 + 2, 30) + GET_INITIATIVE_U_RANK(LOCAL:5) * 2
	COM_PRIORITY:101 += -(TALENT:(LOCAL:5):恥じらい != 0) * 30 + (TALENT:(LOCAL:5):恥薄い != 0) * 10
	;顔面騎乗
	COM_PRIORITY:102 += MIN(ABL:(LOCAL:5):Ａ感 / 2, 30) + GET_INITIATIVE_U_RANK(LOCAL:5) * 2 + GET_PERVERSION_RANK(LOCAL:5) - 2
	COM_PRIORITY:102 += -(TALENT:(LOCAL:5):恥じらい != 0) * 30 + (TALENT:(LOCAL:5):恥薄い != 0) * 10
	COM_PRIORITY:102 += (TALENT:(LOCAL:5):美尻 || TALENT:(LOCAL:5):豊尻) * 5
ENDIF

;スカ系は排泄が必要
IF ABL:(LOCAL:5):排泄 >= 1
	;尿を掛ける
	COM_PRIORITY:131 += -7 + MIN(ABL:(LOCAL:5):排泄, 6) + GET_INITIATIVE_U_RANK(LOCAL:5) * 2 + GET_PERVERSION_RANK(LOCAL:5)
	COM_PRIORITY:131 += (TALENT:(LOCAL:5):倒錯的 != 0) * 6 + GETBIT(TALENT:(LOCAL:5):淫乱系, 素質_淫乱_サド) * 4 - (TALENT:(LOCAL:5):保守的 != 0) * 7
	COM_PRIORITY:131 += (TALENT:(LOCAL:5):恥薄い != 0) * 2 - (TALENT:(LOCAL:5):恥じらい != 0) * 4 + IS_RIDE(LOCAL:5) * 15

	;口内放尿
	COM_PRIORITY:132 += -7 + MIN(ABL:(LOCAL:5):排泄, 6) + GET_INITIATIVE_U_RANK(LOCAL:5) * 2 + GET_PERVERSION_RANK(LOCAL:5)
	COM_PRIORITY:132 += (TALENT:(LOCAL:5):倒錯的 != 0) * 4 + GETBIT(TALENT:(LOCAL:5):淫乱系, 素質_淫乱_サド) * 6 - (TALENT:(LOCAL:5):保守的 != 0) * 7
	COM_PRIORITY:132 += (TALENT:(LOCAL:5):恥薄い != 0) * 2 - (TALENT:(LOCAL:5):恥じらい != 0) * 4 + IS_RIDE(LOCAL:5) * 15

	;顔騎放屁
	COM_PRIORITY:151 += 7 + MIN(ABL:(LOCAL:5):排泄, 6) + GET_INITIATIVE_U_RANK(LOCAL:5) * 2 + GET_PERVERSION_RANK(LOCAL:5)
	COM_PRIORITY:151 += (TALENT:(LOCAL:5):倒錯的 != 0) * 4 + GETBIT(TALENT:(LOCAL:5):淫乱系, 素質_淫乱_サド) * 6 - (TALENT:(LOCAL:5):保守的 != 0) * 7
	COM_PRIORITY:151 += (TALENT:(LOCAL:5):恥薄い != 0) * 4 - (TALENT:(LOCAL:5):恥じらい != 0) * 8
ENDIF

;愛撫
COM_PRIORITY:1000 += 5
;胸愛撫
COM_PRIORITY:1001 += MIN(ABL:(LOCAL:5):欲望 / 2, 3) + MIN(ABL:(LOCAL:5):Ｂ感 / 2 + 2, 30)
;クンニ
COM_PRIORITY:1002 += MIN(ABL:(LOCAL:5):欲望 / 2, 3) + MIN(ABL:(LOCAL:5):Ｃ感 / 2 + 2, 30)
;アナル愛撫
COM_PRIORITY:1004 += MIN(ABL:(LOCAL:5):Ａ感, 5) + GET_PERVERSION_RANK(LOCAL:5) / 2
;アナル舐め
COM_PRIORITY:1008 += MIN(ABL:(LOCAL:5):欲望 / 2, 3) + MIN(ABL:(LOCAL:5):Ａ感, 5) + GET_PERVERSION_RANK(LOCAL:5) / 2

;手コキ
COM_PRIORITY:1010 += 7
;フェラ
COM_PRIORITY:1011 += MIN((ABL:(LOCAL:5):射精 / 2 + ABL:(LOCAL:5):欲望 / 3), 15)


IF LOCAL:7
	IF PENIS(LOCAL:5)
		TIMES COM_PRIORITY:1011, 0.30
	ELSE
		COM_PRIORITY:1011 = 0
	ENDIF
ENDIF

;パイズリ
COM_PRIORITY:1012 += MIN((ABL:(LOCAL:5):射精 / 2 + ABL:(LOCAL:5):欲望 / 3), 15) + GET_BUSTSIZE_NUM(LOCAL:98) * 3

;素股
COM_PRIORITY:1013 += MIN((ABL:(LOCAL:5):射精 / 2 + ABL:(LOCAL:5):欲望 / 4), 10) + (TALENT:(LOCAL:98):豊尻 || TALENT:(LOCAL:98):美尻) * 3


;尻コキ
COM_PRIORITY:1015 += MIN((ABL:(LOCAL:5):射精 / 2 + ABL:(LOCAL:5):欲望 / 5), 10) + (TALENT:(LOCAL:98):豊尻 || TALENT:(LOCAL:98):美尻) * 5

;オナホコキ
COM_PRIORITY:1016 += MIN((ABL:(LOCAL:5):射精 / 4 + ABL:(LOCAL:5):欲望 / 5), 10)

;髪コキ
COM_PRIORITY:1018 += MIN(ABL:(LOCAL:5):射精 / 3 + ABL:(LOCAL:5):欲望 / 5, 10) + TALENT:(LOCAL:98):髪の長さ / 200

;キス
IF CFLAG:(LOCAL:5):2 >= 1500 && (!TALENT:(LOCAL:5):キス未経験 || TALENT:(LOCAL:5):恋慕)
	COM_PRIORITY:1020 += MIN(CFLAG:(LOCAL:5):2 / 100 - 8, 15) - GET_PERVERSION_RANK(LOCAL:5) * 4
	COM_PRIORITY:1020 += (TALENT:(LOCAL:5):素直 != 0) * 5 - (TALENT:(LOCAL:5):反抗的 != 0) * 3 - (TALENT:(LOCAL:5):生意気 != 0) * 8
	COM_PRIORITY:1020 += (TALENT:(LOCAL:5):貞操観念 != 0) * 6 - (TALENT:(LOCAL:5):貞操無頓着 != 0) * 6
	IF SEARCH_EQUIP(LOCAL:5, -1, -1) >= 0 || SEARCH_EQUIP(-1, LOCAL:5, -1) >= 0 || TFLAG:55 <= 2
	ELSEIF GROUPMATCH(FLAG:調教モード, 4, 5)
		COM_PRIORITY:20 -= 10
		TIMES COM_PRIORITY:20, 0.50
	ELSE
		COM_PRIORITY:20 -= 4
		TIMES COM_PRIORITY:20, 0.70
	ENDIF
ENDIF

;性交系は事前に傾向を決定。潤滑不足なら潤滑を増やす行動を設定
SELECTCASE LOCAL:6
	;Ｐ→Ｖ
	CASE 0
		;潤滑不足
		IF GET_PALAMLV(PALAM:(LOCAL:5):潤滑) < 5
			;愛撫
			COM_PRIORITY:1000 += 5
			;クンニ
			COM_PRIORITY:1002 += MIN(ABL:(LOCAL:5):Ｃ感 / 2 + 2, 30)
			;ローション
			COM_PRIORITY:1070 += -4 + GET_PALAMLV(PALAM:(LOCAL:5):欲情) * 2 + ABL:(LOCAL:5):欲望 / 2
		ELSEIF !PENIS(LOCAL:98) && !IS_EQUIP_PLAYER(LOCAL:98, 50) && (ITEM:ペニスバンド || ITEM:A_ペニスバンド)
			;ペニバン装着
			COM_PRIORITY:1050 += 10
		ELSE
			;正常位
			COM_PRIORITY:1030 += 5
			;後背位
			COM_PRIORITY:1031 += GET_PERVERSION_RANK(LOCAL:5)
			;対面座位
			COM_PRIORITY:1032 += MAX(6 - GET_PERVERSION_RANK(LOCAL:5) * 2, 1)
			;背面座位
			COM_PRIORITY:1033 += GET_PERVERSION_RANK(LOCAL:5)
			;騎乗位
			COM_PRIORITY:1034 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 0) + IS_BIND(LOCAL:98) * 8
			;背面騎乗位
			COM_PRIORITY:1035 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 0) + IS_BIND(LOCAL:98) * 8 + GET_PERVERSION_RANK(LOCAL:5) * 2 - 8
			;側位
			COM_PRIORITY:1037 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 0) + IS_BIND(LOCAL:98) * 8 + GET_PERVERSION_RANK(LOCAL:5) * 2 - 8
			;屈曲位
			COM_PRIORITY:1038 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 0) + IS_BIND(LOCAL:98) * 8 + GET_PERVERSION_RANK(LOCAL:5) * 2 - 8
			;二本挿入
			COM_PRIORITY:1036 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5), 0) + IS_BIND(LOCAL:98) * 8 + GET_PERVERSION_RANK(LOCAL:5) - 10
			;順番に挿入
			COM_PRIORITY:1055 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5), 0) + IS_BIND(LOCAL:98) * 8 + GET_PERVERSION_RANK(LOCAL:5) - 10
			;代わる代わる
			COM_PRIORITY:1057 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5), 0) + IS_BIND(LOCAL:98) * 8 + GET_PERVERSION_RANK(LOCAL:5) - 10
		ENDIF
	;Ｐ→Ａ
	CASE 1
		;潤滑不足
		IF GET_PALAMLV(PALAM:(LOCAL:5):潤滑) < 5
			IF VAGINA(LOCAL:5)
				;愛撫
				COM_PRIORITY:1000 += 5
				;クンニ
				COM_PRIORITY:1002 += MIN(ABL:(LOCAL:5):Ｃ感 / 2 + 2, 30)
				;ローション
				COM_PRIORITY:1070 += -4 + GET_PALAMLV(PALAM:(LOCAL:5):欲情) * 2 + ABL:(LOCAL:5):欲望 / 2
			ELSE
				;ローション
				COM_PRIORITY:1070 += 5 + GET_PALAMLV(PALAM:(LOCAL:5):欲情) * 2 + ABL:(LOCAL:5):欲望 / 2
			ENDIF
		ELSEIF !PENIS(LOCAL:98) && !IS_EQUIP_PLAYER(LOCAL:98, 50) && (ITEM:ペニスバンド || ITEM:A_ペニスバンド)
			;ペニバン装着
			COM_PRIORITY:1050 += 10
		ELSE
			;正常位
			COM_PRIORITY:1040 += 5
			;後背位
			COM_PRIORITY:1041 += GET_PERVERSION_RANK(LOCAL:5)
			;対面座位
			COM_PRIORITY:1042 += MAX(6 - GET_PERVERSION_RANK(LOCAL:5) * 2, 1)
			;背面座位
			COM_PRIORITY:1043 += GET_PERVERSION_RANK(LOCAL:5)
			;騎乗位
			COM_PRIORITY:1044 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 0) + IS_BIND(LOCAL:98) * 8
			;背面騎乗位
			COM_PRIORITY:1045 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 0) + IS_BIND(LOCAL:98) * 8 + GET_PERVERSION_RANK(LOCAL:5) * 2 - 8
			;側位
			COM_PRIORITY:1047 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 0) + IS_BIND(LOCAL:98) * 8 + GET_PERVERSION_RANK(LOCAL:5) * 2 - 8
			;屈曲位
			COM_PRIORITY:1048 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 0) + IS_BIND(LOCAL:98) * 8 + GET_PERVERSION_RANK(LOCAL:5) * 2 - 8

			;二本挿入
			COM_PRIORITY:1046 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5), 0) + IS_BIND(LOCAL:98) * 8 + GET_PERVERSION_RANK(LOCAL:5) - 10
			;順番にＡ
			COM_PRIORITY:1056 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5), 0) + IS_BIND(LOCAL:98) * 8 + GET_PERVERSION_RANK(LOCAL:5) - 10
			;代わる代わるＡ
			COM_PRIORITY:1058 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5), 0) + IS_BIND(LOCAL:98) * 8 + GET_PERVERSION_RANK(LOCAL:5) - 10
		ENDIF
	;Ｖ←Ｐ
	CASE 2
		;潤滑不足
		IF GET_PALAMLV(PALAM:(LOCAL:98):潤滑) < 5
			;愛撫
			COM_PRIORITY:0 += 5
			;クンニ
			COM_PRIORITY:2 += MIN(ABL:(LOCAL:98):Ｃ感 / 2 + 2, 30)
			;ローション
			COM_PRIORITY:70 += -4 + GET_PALAMLV(PALAM:(LOCAL:5):欲情) * 2 + ABL:(LOCAL:5):欲望 / 2
		ELSEIF !PENIS(LOCAL:5) && !IS_EQUIP_PLAYER(LOCAL:5, 50) && (ITEM:ペニスバンド || ITEM:A_ペニスバンド)
			;ペニバン装着
			COM_PRIORITY:50 += 10
		ELSE
			;正常位
			COM_PRIORITY:30 += MAX(5 + GET_INITIATIVE_U_RANK(LOCAL:5) - GET_PERVERSION_RANK(LOCAL:5), 1)
			;後背位
			COM_PRIORITY:31 += -3 + GET_INITIATIVE_U_RANK(LOCAL:5) * 2 + GET_PERVERSION_RANK(LOCAL:5)
			;対面座位
			COM_PRIORITY:32 += MAX(6 + GET_INITIATIVE_U_RANK(LOCAL:5) / 2 - GET_PERVERSION_RANK(LOCAL:5) * 2, 1)
			;背面座位
			COM_PRIORITY:33 += -3 + GET_INITIATIVE_U_RANK(LOCAL:5) * 2 + GET_PERVERSION_RANK(LOCAL:5)
			;騎乗位
			COM_PRIORITY:34 += MAX(2 - GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 1)
			;背面騎乗位
			COM_PRIORITY:35 += MAX(2 - GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 1) + GET_PERVERSION_RANK(LOCAL:5)
			;側位
			COM_PRIORITY:37 += MAX(2 - GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 1) + GET_PERVERSION_RANK(LOCAL:5)
			;屈曲位
			COM_PRIORITY:38 += MAX(2 - GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 1) + GET_PERVERSION_RANK(LOCAL:5)
			;二本挿入
			COM_PRIORITY:36 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5) * 2 - 2, 1) + GET_PERVERSION_RANK(LOCAL:5) * 2
			;順番に挿入
			COM_PRIORITY:55 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5) * 2 - 2, 1) + GET_PERVERSION_RANK(LOCAL:5) * 2
			;代わる代わる
			COM_PRIORITY:57 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5) * 2 - 2, 1) + GET_PERVERSION_RANK(LOCAL:5) * 2
		ENDIF
	;Ａ←Ｐ
	CASE 3
		;潤滑不足（対象が男なら無視）
		IF !IS_MALE(LOCAL:98) && GET_PALAMLV(PALAM:(LOCAL:98):潤滑) < 5
			IF VAGINA(LOCAL:98)
				;愛撫
				COM_PRIORITY:0 += 5
				;クンニ
				COM_PRIORITY:2 += MIN(ABL:(LOCAL:98):Ｃ感 / 2 + 2, 30)
				;ローション
				COM_PRIORITY:70 += -4 + GET_PALAMLV(PALAM:(LOCAL:5):欲情) * 2 + ABL:(LOCAL:5):欲望 / 2
			ELSE
				;ローション
				COM_PRIORITY:70 += 5 + GET_PALAMLV(PALAM:(LOCAL:5):欲情) * 2 + ABL:(LOCAL:5):欲望 / 2
			ENDIF
		ELSEIF !PENIS(LOCAL:5) && !IS_EQUIP_PLAYER(LOCAL:5, 50) && (ITEM:ペニスバンド || ITEM:A_ペニスバンド)
			;ペニバン装着
			COM_PRIORITY:50 += 10
		ELSE
			;正常位
			COM_PRIORITY:40 +=  MAX(5 + GET_INITIATIVE_U_RANK(LOCAL:5) + GET_PERVERSION_RANK(LOCAL:5), 1)
			;後背位
			COM_PRIORITY:41 += -3 + GET_INITIATIVE_U_RANK(LOCAL:5) * 2 + GET_PERVERSION_RANK(LOCAL:5)
			;対面座位
			COM_PRIORITY:42 +=  MAX(6 + GET_INITIATIVE_U_RANK(LOCAL:5) / 2 + GET_PERVERSION_RANK(LOCAL:5) * 2, 1)
			;背面座位
			COM_PRIORITY:43 += -3 + GET_INITIATIVE_U_RANK(LOCAL:5) * 2 + GET_PERVERSION_RANK(LOCAL:5)
			;騎乗位
			COM_PRIORITY:44 += MAX(2 - GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 1)
			;背面騎乗位
			COM_PRIORITY:45 += MAX(2 - GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 1) + GET_PERVERSION_RANK(LOCAL:5)
			;側位
			COM_PRIORITY:47 += MAX(2 - GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 1) + GET_PERVERSION_RANK(LOCAL:5)
			;屈曲位
			COM_PRIORITY:48 += MAX(2 - GET_INITIATIVE_U_RANK(LOCAL:5) * 2, 1) + GET_PERVERSION_RANK(LOCAL:5)
			;二本挿入
			COM_PRIORITY:46 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5) * 2 - 3, 1) + GET_PERVERSION_RANK(LOCAL:5) * 2
			;順番に挿入
			COM_PRIORITY:56 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5) * 2 - 3, 1) + GET_PERVERSION_RANK(LOCAL:5) * 2
			;代わる代わる
			COM_PRIORITY:58 += MAX(GET_INITIATIVE_U_RANK(LOCAL:5) * 2 - 3, 1) + GET_PERVERSION_RANK(LOCAL:5) * 2
		ENDIF
	;Ｖ－Ｖ
	CASE 4
ENDSELECT

;麻薬
IF TFLAG:55 <= TFLAG:56 / 2 && ITEM:A_麻薬 && (FLAG:調教モード == 4 || flag:調教モード == 5 || FLAG:調教モード == 7)
	COM_PRIORITY:74 += -20 + GET_INITIATIVE_U_RANK(LOCAL:5)
	COM_PRIORITY:74 += (TALENT:(LOCAL:5):技師 != 0) * 3 + GETBIT(TALENT:(LOCAL:5):淫乱系, 素質_淫乱_サド) * 3 + (TALENT:(LOCAL:5):倒錯的 != 0) * 3
	COM_PRIORITY:74 += ABL:(LOCAL:5):欲望
	COM_PRIORITY:74 += TFLAG:55 * 2
ENDIF

;スパンキング
COM_PRIORITY:81 += MAX(5 - GET_PERVERSION_RANK(LOCAL:5), 1)
COM_PRIORITY:81 += (TALENT:(LOCAL:98):美尻 || TALENT:(LOCAL:98):豊尻) * 3
;鞭
COM_PRIORITY:82 += -2 + GET_PERVERSION_RANK(LOCAL:5) * 2
;針
;COM_PRIORITY:83 += -5 + GET_PERVERSION_RANK(LOCAL:5) * 2
;縄
COM_PRIORITY:85 += GET_PERVERSION_RANK(LOCAL:5)
;平手打ち
COM_PRIORITY:89 += MAX(4 - GET_PERVERSION_RANK(LOCAL:5), 1) + TALENT:(LOCAL:5):生意気
SIF CFLAG:(LOCAL:5):所属 == CFLAG:(LOCAL:98):所属
	COM_PRIORITY:89 /= 2
;鼻フック
COM_PRIORITY:93 += GET_PERVERSION_RANK(LOCAL:5) / 2 + TALENT:(LOCAL:98):特殊勢力素質 * -5
;首絞め
COM_PRIORITY:94 += MAX(4 - GET_PERVERSION_RANK(LOCAL:5), 1) / 2

;ハラパン
COM_PRIORITY:97 += MAX(4 - GET_PERVERSION_RANK(LOCAL:5), 1)


SIF CFLAG:(LOCAL:5):所属 == CFLAG:(LOCAL:98):所属
	COM_PRIORITY:97 /= 2
;ゴム
COM_PRIORITY:1075 += ABL:(LOCAL:5):性知識 / 2 - ABL:(LOCAL:5):欲望 / 2 - ABL:(LOCAL:5):性交 / 2
COM_PRIORITY:1075 += TALENT:(LOCAL:5):保守的 * 3 + TALENT:(LOCAL:5):貞操観念 * 5 + TALENT:(LOCAL:5):好奇心 * -4  + TALENT:(LOCAL:5):一線越えない * 5
COM_PRIORITY:1075 += GETBIT(TALENT:(LOCAL:5):淫乱系, 素質_淫乱_淫乱) * -10
COM_PRIORITY:1075 += TALENT:(LOCAL:5):特殊勢力素質 * -10
COM_PRIORITY:1075 += GET_PERVERSION_RANK(LOCAL:5) * -1 + GET_INITIATIVE_U_RANK(LOCAL:5) / 2

;自慰
COM_PRIORITY:1100 += 5 + ABL:(LOCAL:5):欲望 / 2
COM_PRIORITY:1100 += (TALENT:(LOCAL:5):好奇心 != 0) * 3 - (TALENT:(LOCAL:5):恥じらい != 0) * 4

;羞恥プレイ
COM_PRIORITY:112 += GET_INITIATIVE_U_RANK(LOCAL:5)

;落書き
COM_PRIORITY:114 += GET_INITIATIVE_U_RANK(LOCAL:5)

;足を舐める
COM_PRIORITY:1104 += GET_INITIATIVE_U_RANK(LOCAL:5) * 2
COM_PRIORITY:1104 += (TALENT:(LOCAL:5):恥薄い != 0) * 5 - (TALENT:(LOCAL:5):恥じらい != 0) * 7 + (TALENT:(LOCAL:5):プライド高い != 0) * 7
COM_PRIORITY:1104 += TALENT:(LOCAL:5):美脚 * 2
;土下座
COM_PRIORITY:1110 += GET_INITIATIVE_U_RANK(LOCAL:5) * 2
;おねだり
COM_PRIORITY:1111 += GET_INITIATIVE_U_RANK(LOCAL:5) * 2

;スカ系は排泄Lv2以上が必要
IF ABL:(LOCAL:5):排泄 >= 2
	;放尿する
	COM_PRIORITY:1130 += -7 + MIN(ABL:(LOCAL:5):排泄, 6) + GET_INITIATIVE_U_RANK(LOCAL:5) + GET_PERVERSION_RANK(LOCAL:5) * 2
	COM_PRIORITY:1130 += (TALENT:(LOCAL:5):倒錯的 != 0) * 5 + (TALENT:(LOCAL:5):好奇心 != 0) * 4 - (TALENT:(LOCAL:5):保守的 != 0) * 7

	;放屁する
	;COM_PRIORITY:1150 += 10 + MIN(ABL:(LOCAL:5):排泄, 10) + GET_INITIATIVE_U_RANK(LOCAL:5) + GET_PERVERSION_RANK(LOCAL:5) * 2
	;COM_PRIORITY:1150 += (TALENT:(LOCAL:5):倒錯的 != 0) * 4 + (TALENT:(LOCAL:5):小悪魔 != 0) * 4 - (TALENT:(LOCAL:5):保守的 != 0) * 7
ENDIF

;触手召喚中でない
IF !IS_EQUIP_PLAYER(LOCAL:5, 200)
	;触手召喚
	COM_PRIORITY:200 += 5
;触手召喚中
ELSE
	;触手挿入
	COM_PRIORITY:201 += 10 - IS_EQUIP_PLAYER(LOCAL:5, 201) * 8
	;触手Ａ挿入
	COM_PRIORITY:202 += 10 - IS_EQUIP_PLAYER(LOCAL:5, 202) * 8
	;触手クリ責め
	COM_PRIORITY:203 += 10 - IS_EQUIP_PLAYER(LOCAL:5, 203) * 8
	;触手胸愛撫
	COM_PRIORITY:204 += 10 - IS_EQUIP_PLAYER(LOCAL:5, 204) * 8
	;触手オナホ
	COM_PRIORITY:205 += 10 - IS_EQUIP_PLAYER(LOCAL:5, 205) * 8
	;触手コキ
	COM_PRIORITY:206 += 10 - IS_EQUIP_PLAYER(LOCAL:5, 206) * 8
	;触手搾乳
	COM_PRIORITY:207 += 10 - IS_EQUIP_PLAYER(LOCAL:5, 207) * 8
	;触手オナニー
	COM_PRIORITY:211 += -10 + MIN(ABL:(LOCAL:5):欲望 / 2, 8) + MIN(ABL:(LOCAL:5):露出 , 10)
	COM_PRIORITY:211 += (TALENT:(LOCAL:5):目立ちたがり != 0) * 6 + (TALENT:(LOCAL:5):快感に素直 != 0) * 4
	COM_PRIORITY:211 += -(TALENT:(LOCAL:5):献身的 != 0) * 3 - (TALENT:(LOCAL:5):快感の否定 != 0) * 4 - (TALENT:(LOCAL:5):自制心 != 0) * 3
	COM_PRIORITY:211 += -(TALENT:(LOCAL:5):恥じらい != 0) * 4 + (TALENT:(LOCAL:5):恥薄い != 0) * 3
ENDIF

;忠誠を誓わせる(逆調教)
COM_PRIORITY:298 += 100

;●前回実行したコマンドの優先度を1/4にする
IF PREVCOM >= 0
	IF PREVCOM_TYPE == 0
		COM_PRIORITY:(PREVCOM + 1000) /= 4
	ELSEIF PREVCOM_TYPE == 1
		COM_PRIORITY:PREVCOM /= 4
	ELSE
		COM_PRIORITY:(PREVCOM + 2000) /= 4
	ENDIF
ENDIF

;●選択不可能なコマンドの優先度を0にする
;コマンド判定フラグON
COM_ENABLE = 1

;主導権を中心となるキャラに渡す
FLAG:主導権所有者 = LOCAL:5

CALL CLEAR_MPLY()
CALL CLEAR_MTAR()
CALL ADD_MPLY(LOCAL:5)
CALL ADD_MTAR(LOCAL:98)
FOR LOCAL:0, 0, 1000
	RESULT = 0
	TRYCALLFORM COM_ABLE{LOCAL:0}
	IF !RESULT
		COM_PRIORITY:(LOCAL:0) = 0
	ENDIF
NEXT
CALL CLEAR_MPLY()
CALL CLEAR_MTAR()
CALL ADD_MPLY(LOCAL:98)
CALL ADD_MTAR(LOCAL:5)
FOR LOCAL:0, 0, 1000
	RESULT = 0
	TRYCALLFORM COM_ABLE{LOCAL:0}
	;順番挿入、代わる代わる挿入はここでは必ず実行不可が帰ってくるので、回避
	IF !RESULT && !GROUPMATCH(LOCAL:0, 55, 56, 57, 58)
		COM_PRIORITY:(LOCAL:0 + 1000) = 0
	ENDIF
NEXT

;コマンド判定フラグOFF
COM_ENABLE = 0

;●コマンドの優先度をカテゴリごとの実行確率に合わせて正規化
LOCAL:80 = 0
FOR LOCAL:0, 0, 10
	LOCAL:80 += CATEGORY_PRIORITY:(LOCAL:0)
NEXT
IF LOCAL:80 >= 1
	FOR LOCAL:0, 0, 10
		CATEGORY_PRIORITY:(LOCAL:0) = CATEGORY_PRIORITY:(LOCAL:0) * 10000 / LOCAL:80
	NEXT
ELSE
	CATEGORY_PRIORITY:1 = 10000
ENDIF

FOR LOCAL:0, 0, 3000
	COM_PRIORITY_SUM:(COM_CATEGORY:(LOCAL:0)) += MAX(COM_PRIORITY:(LOCAL:0), 0)
NEXT
FOR LOCAL:0, 0, 3000
	IF COM_PRIORITY:(LOCAL:0) > 0
		LOCAL:50 = COM_PRIORITY_SUM:(COM_CATEGORY:(LOCAL:0))
		LOCAL:51 = CATEGORY_PRIORITY:(COM_CATEGORY:(LOCAL:0))
		IF LOCAL:50 >= 1 && LOCAL:51 >= 1
			COM_PRIORITY:(LOCAL:0) = COM_PRIORITY:(LOCAL:0) * LOCAL:51 * 100 / LOCAL:50
		ELSE
			COM_PRIORITY:(LOCAL:0) = 0
		ENDIF
	ENDIF
NEXT

;●性癖設定で好みLvを設定したコマンドは、カテゴリの選択率を無視して優先度を上げる
LOCAL:80 = 0
LOCAL:81 = 300000
LOCAL:82 = 800000
LOCAL:83 = 2000000
LOCAL:90 = 1
LOCAL:91 = 2
LOCAL:92 = 4
LOCAL:93 = 12
FOR LOCAL:0, 0, 300
	COM_PRIORITY:(LOCAL:0) = MAX(COM_PRIORITY:(LOCAL:0), 0) * LOCAL:(COM_TENDENCY:(LOCAL:5):(LOCAL:0) + 90)
	COM_PRIORITY:(LOCAL:0) += LOCAL:(COM_TENDENCY:(LOCAL:5):(LOCAL:0) + 80)
	COM_PRIORITY:(LOCAL:0 + 1000) = MAX(COM_PRIORITY:(LOCAL:0 + 1000), 0) * LOCAL:(COM_TENDENCY:(LOCAL:5):(LOCAL:0 + 300) + 90)
	COM_PRIORITY:(LOCAL:0 + 1000) += LOCAL:(COM_TENDENCY:(LOCAL:5):(LOCAL:0 + 300) + 80)
	;COM_PRIORITY:(LOCAL:0 + 2000) = MAX(COM_PRIORITY:(LOCAL:0 + 2000), 0) * LOCAL:(COM_TENDENCY:(LOCAL:5):(LOCAL:0 + 600) + 90)
	;COM_PRIORITY:(LOCAL:0 + 2000) += LOCAL:(COM_TENDENCY:(LOCAL:5):(LOCAL:0 + 600) + 80)
NEXT

;●一部のコマンドは潤滑不足なら選択禁止
IF (!IS_MALE(LOCAL:98)) && GET_PALAMLV(PALAM:(LOCAL:98):潤滑) < 5
	COM_PRIORITY:6 = 0
	COM_PRIORITY:7 = 0
	COM_PRIORITY:21 = 0
	COM_PRIORITY:22 = 0
	VARSET COM_PRIORITY, 0, 30, 36
	VARSET COM_PRIORITY, 0, 40, 46
	COM_PRIORITY:55 = 0
	COM_PRIORITY:56 = 0
	COM_PRIORITY:57 = 0
	COM_PRIORITY:58 = 0
	COM_PRIORITY:61 = 0
	COM_PRIORITY:62 = 0
	COM_PRIORITY:65 = 0
	COM_PRIORITY:66 = 0
	COM_PRIORITY:87 = 0
	COM_PRIORITY:88 = 0
	COM_PRIORITY:201 = 0
	COM_PRIORITY:202 = 0
	COM_PRIORITY:212 = 0
	COM_PRIORITY:213 = 0
	COM_PRIORITY:1013 = 0
	COM_PRIORITY:1021 = 0
	COM_PRIORITY:1022 = 0
ENDIF
IF (!IS_MALE(LOCAL:5) ) && GET_PALAMLV(PALAM:(LOCAL:5):潤滑) < 5
	COM_PRIORITY:1006 = 0
	COM_PRIORITY:1007 = 0
	COM_PRIORITY:1021 = 0
	COM_PRIORITY:1022 = 0
	VARSET COM_PRIORITY, 0, 1030, 1036
	VARSET COM_PRIORITY, 0, 1040, 1046
	COM_PRIORITY:1055 = 0
	COM_PRIORITY:1056 = 0
	COM_PRIORITY:1057 = 0
	COM_PRIORITY:1058 = 0
	COM_PRIORITY:1061 = 0
	COM_PRIORITY:1062 = 0
	COM_PRIORITY:1065 = 0
	COM_PRIORITY:1066 = 0
	COM_PRIORITY:1087 = 0
	COM_PRIORITY:1088 = 0
	COM_PRIORITY:1201 = 0
	COM_PRIORITY:1202 = 0
	COM_PRIORITY:1212 = 0
	COM_PRIORITY:1213 = 0
	COM_PRIORITY:13 = 0
	COM_PRIORITY:21 = 0
	COM_PRIORITY:22 = 0
ENDIF

;●逆調教かつ竿を弄らない設定なら一部のコマンドを実行禁止にする
IF FLAG:調教モード == 5 && CONFIG:8 == 1
	COM_PRIORITY:0 = 0
	COM_PRIORITY:5 = 0
	COM_PRIORITY:10 = 0
	COM_PRIORITY:11 = 0
	COM_PRIORITY:12 = 0
	COM_PRIORITY:13 = 0
	COM_PRIORITY:14 = 0
	COM_PRIORITY:15 = 0
	COM_PRIORITY:16 = 0
	COM_PRIORITY:17 = 0
	COM_PRIORITY:103 = 0
	COM_PRIORITY:205 = 0
	COM_PRIORITY:206 = 0
	COM_PRIORITY:1030 = 0
	COM_PRIORITY:1031 = 0
	COM_PRIORITY:1032 = 0
	COM_PRIORITY:1033 = 0
	COM_PRIORITY:1034 = 0
	COM_PRIORITY:1035 = 0
	COM_PRIORITY:1037 = 0
	COM_PRIORITY:1038 = 0
	COM_PRIORITY:1040 = 0
	COM_PRIORITY:1041 = 0
	COM_PRIORITY:1042 = 0
	COM_PRIORITY:1043 = 0
	COM_PRIORITY:1044 = 0
	COM_PRIORITY:1045 = 0
	COM_PRIORITY:1047 = 0
	COM_PRIORITY:1048 = 0
	COM_PRIORITY:1090 = 0
	COM_PRIORITY:1100 = 0
	COM_PRIORITY:1211 = 0
ENDIF

;一部コマンドは性別でプライオリティを下げる
IF IS_MALE(LOCAL:5)
	COM_PRIORITY:11 /= 3
	COM_PRIORITY:12 /= 3
	COM_PRIORITY:13 /= 3
	COM_PRIORITY:15 /= 3
	COM_PRIORITY:106 /= 3
	COM_PRIORITY:107 /= 3
	COM_PRIORITY:110 /= 3
	COM_PRIORITY:111 /= 3
ENDIF

;特殊勢力のキャラか、特殊勢力に堕ちたキャラで逆調教でなければ、麻薬は使用しない
IF !(GROUPMATCH(FLAG:調教モード, 4, 5, 7) && (IS_SP_COUNTRY_CHARA(LOCAL:5) || IS_FALLEN_TO_SP_COUNTRY(LOCAL:5)))
	COM_PRIORITY:74 = 0
ENDIF




;ペニバン装着中ならペニバン装着を除外
;IF IS_EQUIP_PLAYER(LOCAL:5, 50)
;	COM_PRIORITY:50 = 0
;ENDIF
;IF IS_EQUIP_PLAYER((LOCAL:98), 50)
;	COM_PRIORITY:1050 = 0
;ENDIF

;フィルタしてるやつを除外
FOR LOCAL, 0, 1000
	IF COM_FILTER:(LOCAL:0)
		COM_PRIORITY:(LOCAL:0) = 0
		COM_PRIORITY:(LOCAL:0 + 1000) = 0
	ENDIF
NEXT


;●再度選択不可能なコマンドの優先度を0にする
;コマンド判定フラグON
COM_ENABLE = 1

;主導権を中心となるキャラに渡す
FLAG:主導権所有者 = LOCAL:5

CALL CLEAR_MPLY()
CALL CLEAR_MTAR()
CALL ADD_MPLY(LOCAL:5)
CALL ADD_MTAR(LOCAL:98)
FOR LOCAL:0, 0, 1000
	RESULT = 0
	TRYCALLFORM COM_ABLE{LOCAL:0}
	;順番挿入、代わる代わる挿入はここでは必ず実行不可が帰ってくるので、回避
	IF !RESULT && !GROUPMATCH(LOCAL:0, 36, 46, 55, 56, 57, 58)
		COM_PRIORITY:(LOCAL:0) = 0
	ENDIF
NEXT
CALL CLEAR_MPLY()
CALL CLEAR_MTAR()
CALL ADD_MPLY(LOCAL:98)
CALL ADD_MTAR(LOCAL:5)
FOR LOCAL:0, 0, 1000
	RESULT = 0
	TRYCALLFORM COM_ABLE{LOCAL:0}
	;順番挿入、代わる代わる挿入はここでは必ず実行不可が帰ってくるので、回避
	IF !RESULT && !GROUPMATCH(LOCAL:0, 1036, 1046, 1055, 1056, 1057, 1058)
		COM_PRIORITY:(LOCAL:0 + 1000) = 0
	ENDIF
NEXT

;コマンド判定フラグOFF
COM_ENABLE = 0

;★
;コマンド実行値の表示
;FOR LOCAL:0, 0, 2000
;	IF COM_PRIORITY:(LOCAL:0) > 0
;		PRINTFORML {LOCAL:0, 3}:{COM_PRIORITY:(LOCAL:0)}
;	ENDIF
;NEXT

;●実行するコマンドを決定
LOCAL:9 = 0
LOCAL:10 = 0
FOR LOCAL:0, 0, 3000
	LOCAL:10 += MAX(COM_PRIORITY:(LOCAL:0), 0)
NEXT
IF LOCAL:10 >= 1
	CATEGORY_PRIORITY:1 = RAND:(LOCAL:10)
	FOR LOCAL:0, 0, 3000
		CATEGORY_PRIORITY:1 -= MAX(COM_PRIORITY:(LOCAL:0), 0)
		IF CATEGORY_PRIORITY:1 < 0
			LOCAL:9 = LOCAL:0
			BREAK
		ENDIF
	NEXT
ENDIF

CALL CLEAR_MPLY()
CALL CLEAR_MTAR()


;メインのプレイヤー・ターゲットの設定
IF LOCAL:9 < 1000
	CALL ADD_MPLY(LOCAL:5)
	CALL ADD_MTAR(LOCAL:98)
ELSEIF LOCAL:9 < 2000
	CALL ADD_MPLY(LOCAL:98)
	CALL ADD_MTAR(LOCAL:5)
ELSE
ENDIF

CALL AUTO_SET_THIRD_PERSON(LOCAL:5, LOCAL:98, LOCAL:9)

;ここまできてコマンドが実行できなければやり直し
;代わる代わる挿入など、最初の方の優先度判定でのCOM_ABLEを回避してきたやつが未だに実行不可なら、ここでひっかけて殺す
COM_ENABLE = 1
TRYCALLFORM COM_ABLE{LOCAL:9 % 1000}
IF !RESULT
	IF LOOP_CNT < 200
		GOTO RESTARTED
	ELSE
		PRINTFORML (実行可能なコマンドが見つかりません)
		PRINTFORML (コマンドにフィルタをかけすぎたりすると発生します)
		PRINTFORML (状況を無視し、強制的に『愛撫する』を選択します)
		LOCAL:10 = 0
		LOOP_CNT = 0
		GOTO SKIPPED
	ENDIF
ENDIF
LOOP_CNT = 0
COM_ENABLE = 0
TFLAG:30 = 0

;特定のコマンドを行った場合は次回選択するカテゴリを予約しておく
SELECTCASE LOCAL:9
	CASE 70
		;ローション→性交
		TFLAG:30 = 3
	CASE 1070
		;ローション→性交
		TFLAG:30 = 13
	CASE 50
		;ペニバン装着→性交
		TFLAG:30 = 3
	CASE 1050
		;ペニバン装着→性交
		TFLAG:30 = 13
	CASE 200
		;触手召喚→触手愛撫
		TFLAG:30 = 6
	CASE 1200
		;触手召喚させる→触手愛撫させる
		TFLAG:30 = 7
ENDSELECT

LOCAL:10 = LOCAL:9 % 1000
CATEGORY_PRIORITY:1 = LOCAL:10 + LOCAL:9 / 1000 * 300
;●継続状態の設定
RESULT = 0
TRYCALLFORM COM_IS_EQUIP{LOCAL:10}
;継続状態が不可能なコマンドの場合
IF RESULT == 0
	;非継続フラグON
	TFLAG:1 = 1
;常に継続状態で実行されるコマンドの場合
ELSEIF RESULT == 2
	;非継続フラグOFF
	TFLAG:1 = 0
;継続、非継続のどちらでも可能なコマンドの場合
ELSE
	;挿入など一部のコマンドは常に継続
	IF (LOCAL:10 >= 30 && LOCAL:10 <= 49) || GROUPMATCH(LOCAL:10, 10, 11, 12, 13, 15, 16, 21, 22, 55, 56, 57, 58, 90, 100, 201, 202, 203, 204, 205, 206, 207, 210)
		;非継続フラグOFF
		TFLAG:1 = 0
	;その他のコマンドは性癖などを元に決める
	ELSE
		LOCAL:12 = COM_TENDENCY:(LOCAL:5):(LOCAL:10)
		LOCAL:20 = 15
		LOCAL:21 = 40
		LOCAL:22 = 80
		LOCAL:23 = 100
		IF RAND:100 < LOCAL:(LOCAL:12 + 20)
			;非継続フラグOFF
			TFLAG:1 = 0
		ELSE
			;非継続フラグON
			TFLAG:1 = 1
		ENDIF
	ENDIF
ENDIF
$SKIPPED
DOTRAIN LOCAL:10

;-------------------------------------------------
;主導度Ｕによる補正値を取得する関数  ARG:0=キャラ番号
;-------------------------------------------------
@GET_INITIATIVE_U_RANK(ARG:0)
#FUNCTION
IF GETBIT(TALENT:(ARG:0):淫乱系, 素質_淫乱_サド)
	RETURNF 6
ELSEIF ABL:(ARG:0):主導度Ｕ >= 500
	RETURNF 5
ELSEIF ABL:(ARG:0):主導度Ｕ >= 300
	RETURNF 3
ELSEIF ABL:(ARG:0):主導度Ｕ >= 100
	RETURNF 1
ELSEIF ABL:(ARG:0):主導度Ｕ > -100
	RETURNF 0
ELSEIF ABL:(ARG:0):主導度Ｕ > -300
	RETURNF -1
ELSEIF ABL:(ARG:0):主導度Ｕ > -500
	RETURNF -3
ELSE
	RETURNF -5
ENDIF

;-------------------------------------------------
;倒錯度による補正値を取得する関数  ARG:0=キャラ番号
;-------------------------------------------------
@GET_PERVERSION_RANK(ARG:0)
#FUNCTION
IF GETBIT(TALENT:(ARG:0):淫乱系, 素質_淫乱_サド) || GETBIT(TALENT:(ARG:0):淫乱系, 素質_淫乱_マゾ)
	RETURNF 7
ELSEIF ABL:(ARG:0):倒錯度 >= 800
	RETURNF 6
ELSEIF ABL:(ARG:0):倒錯度 >= 500
	RETURNF 4
ELSEIF ABL:(ARG:0):倒錯度 >= 300
	RETURNF 2
ELSEIF ABL:(ARG:0):倒錯度 >= 100
	RETURNF 1
ELSE
	RETURNF 0
ENDIF

;-------------------------------------------------
;おまかせ時の自動EQUIP解除
;-------------------------------------------------
@AUTO_EQUIP_RELEASE
;行動可能なキャラの数を調べる
LOCAL:10 = 0
FOR LOCAL:0, 0, CHARANUM
	IF IS_AUTOSELECT(LOCAL:0)
		LOCAL:10 ++
	ENDIF
NEXT

IF LOCAL:10 >= 3
	LOCAL:11 = 40
ELSEIF LOCAL:10 >= 2
	LOCAL:11 = 25
ELSE
	LOCAL:11 = 15
ENDIF

;射精した／されたならランダムでEQUIP解除
FOR LOCAL:0, 0, CHARANUM
	IF LOCAL:0 != MASTER && CFLAG:(LOCAL:0):調教参加フラグ
		;ゴム解除
		IF NOWEX:(LOCAL:0):射精 >= 1
			LOCAL:3 = SEARCH_EQUIP(75, -1, LOCAL:0)
			SIF LOCAL:3 >= 0 && RAND:100 <= MEQUIP_TURN:(LOCAL:3) * 3 && FLAG:調教モード != 調教_閨
				CALL RELEASE_EQUIP(LOCAL:3, 1)
		ENDIF
		;抜かない確率の設定
		LOCAL:2 = 30 + MIN(ABL:(LOCAL:0):欲望 * 6 + ABL:(LOCAL:0):性交 * 6 + GET_PERVERSION_RANK(LOCAL:0) * 5, 200)
		;自前の竿の場合
		IF PENIS(LOCAL:0)
			;このキャラが相手に膣内／腸内射精した場合
			IF NOWEX:(LOCAL:0):射精 >= 1
				FOR LOCAL:1, 30, 50
					LOCAL:3 = SEARCH_EQUIP(LOCAL:1, LOCAL:0, -1)
					IF LOCAL:3 >= 0 && RAND:100 >= LOCAL:2 - MEQUIP_TURN:(LOCAL:3) * LOCAL:11
						WAIT
						PRINTL 
						CALL RELEASE_EQUIP(LOCAL:3, 1)
						BREAK
					ENDIF
				NEXT
			ENDIF

			;このキャラが相手に口内射精した場合
			IF NOWEX:(LOCAL:0):射精 >= 1
				LOCAL:3 = SEARCH_EQUIP(90, LOCAL:0, -1)
				IF LOCAL:3 >= 0 && RAND:100 >= LOCAL:2 / 2 - MEQUIP_TURN:(LOCAL:3) * 30
					WAIT
					PRINTL 
					CALL RELEASE_EQUIP(LOCAL:3, 1)
					BREAK
				ENDIF
			ENDIF

		;ペニバンの場合
		ELSE
			;性交関係
			FOR LOCAL:1, 30, 50
				LOCAL:3 = SEARCH_EQUIP(LOCAL:1, LOCAL:0, -1)
				IF LOCAL:3 >= 0 && MEQUIP_TURN:(LOCAL:3) >= 4 && RAND:100 >= LOCAL:2 - MEQUIP_TURN:(LOCAL:3) * LOCAL:11
					WAIT
					PRINTL 
					CALL RELEASE_EQUIP(LOCAL:3, 1)
					BREAK
				ENDIF
			NEXT

			;イラマチオ
			LOCAL:3 = SEARCH_EQUIP(90, LOCAL:0, -1)
			IF LOCAL:3 >= 0 && MEQUIP_TURN:(LOCAL:3) >= 4 && RAND:100 >= LOCAL:2 / 2 - MEQUIP_TURN:(LOCAL:3) * 30
				WAIT
				PRINTL 
				CALL RELEASE_EQUIP(LOCAL:3, 1)
				BREAK
			ENDIF
		ENDIF

		;相手からの挿入
		FOR LOCAL:1, 30, 50
			LOCAL:3 = SEARCH_EQUIP(LOCAL:1, -1, LOCAL:0)
			IF LOCAL:3 >= 0
				LOCAL:4 = MEQUIP_PLAYER:(LOCAL:3):0
				;相手に竿がある場合
				IF PENIS(LOCAL:4)
					;相手がこのキャラに膣内／腸内射精した場合に引き抜き判定
					IF NOWEX:(LOCAL:4):射精 >= 1 && RAND:100 >= LOCAL:2 - MEQUIP_TURN:(LOCAL:3) * LOCAL:11
						WAIT
						PRINTL 
						CALL RELEASE_EQUIP(LOCAL:3, 1)
						BREAK
					ENDIF
				;相手がペニバンを使っている場合
				ELSE
					;４ターン以上経過していれば常に引き抜き判定
					IF MEQUIP_TURN:(LOCAL:3) >= 4 && RAND:100 >= LOCAL:2 - MEQUIP_TURN:(LOCAL:3) * LOCAL:11
						WAIT
						PRINTL 
						CALL RELEASE_EQUIP(LOCAL:3, 1)
						BREAK
					ENDIF
				ENDIF
			ENDIF
		NEXT

		;相手からのイラマ
		LOCAL:3 = SEARCH_EQUIP(90, -1, LOCAL:0)
		IF LOCAL:3 >= 0
			LOCAL:4 = MEQUIP_PLAYER:(LOCAL:3):0
			;相手に竿がある場合
			IF PENIS(LOCAL:4)
				;相手がこのキャラに口内射精した場合に引き抜き判定
				IF NOWEX:(LOCAL:4):射精 >= 1 && RAND:100 >= LOCAL:2 - MEQUIP_TURN:(LOCAL:3) * 30
					WAIT
					PRINTL 
					CALL RELEASE_EQUIP(LOCAL:3, 1)
					BREAK
				ENDIF
			;相手がペニバンを使っている場合
			ELSE
				;４ターン以上経過していれば常に引き抜き判定
				IF MEQUIP_TURN:(LOCAL:3) >= 4 && RAND:100 >= LOCAL:2 - MEQUIP_TURN:(LOCAL:3) * 30
					WAIT
					PRINTL 
					CALL RELEASE_EQUIP(LOCAL:3, 1)
					BREAK
				ENDIF
			ENDIF
		ENDIF
	ENDIF
NEXT

;挿入・縄・イラマ・ゴム・触手以外は最低３ターン継続し、一律35%で解除
FOR LOCAL:0, 0, MAX_MEQUIP
	IF !GROUPMATCH(MEQUIP:(LOCAL:0), 30, 31, 32, 33, 34, 35, 40, 41, 42, 43, 44, 45, 50, 75, 85, 90, 94, 200)
		IF MEQUIP:(LOCAL:0) >= 201 && MEQUIP:(LOCAL:0) <= 219
			IF MEQUIP_TURN:(LOCAL:0) >= 6 && RAND:100 < 20
				CALL RELEASE_EQUIP(LOCAL:0, 1)
			ENDIF
		ELSE
			IF MEQUIP_TURN:(LOCAL:0) >= 3 && RAND:100 < 35
				CALL RELEASE_EQUIP(LOCAL:0, 1)
			ENDIF
		ENDIF
	ENDIF
NEXT

;-------------------------------------------------
;おまかせ時のプレイヤー選択
;-------------------------------------------------
@COM_AUTOSELECT_DECIDE_PLAYER
;行動可能なキャラの一覧
#DIM CHARA_LIST, 8

;行動可能なキャラの数
#DIM CHARA_LIST_MAX

;主人公と挿入状態にあるキャラの一覧
#DIM INSERT_LIST, 8

;主人公と挿入状態にあるキャラの数
#DIM INSERT_LIST_MAX

#DIM 行動候補, 8

VARSET 行動候補, -1

CHARA_LIST_MAX = 0
INSERT_LIST_MAX = 0

;●キャラの選択
;行動可能なキャラ、主人公と挿入状態にあるキャラの数を調べる
FOR LOCAL:0, 0, CHARANUM
	IF IS_AUTOSELECT(LOCAL:0)
		CHARA_LIST:(CHARA_LIST_MAX) = LOCAL:0
		CHARA_LIST_MAX ++
		IF IS_INSERT_MUTUAL(MASTER, LOCAL:0) >= 1
			INSERT_LIST:(INSERT_LIST_MAX) = LOCAL:0
			INSERT_LIST_MAX ++
		ENDIF
	ENDIF
NEXT

IF CHARA_LIST_MAX == 0
	PRINTFORML (行動可能な者が一人もいません。何もしないが選択されます)
	CALL CLEAR_MTAR()
	CALL CLEAR_MPLY()
	CALL ADD_MPLY(MASTER)
	LOCAL:10 = 292
	RETURN -1
ENDIF

;中心となるキャラの選択
IF INSERT_LIST_MAX >= 1 && RAND:10 < 3
	;主人公と挿入状態にあるキャラが1人以上いれば、30%の確率でその中から選択
	LOCAL:5 = INSERT_LIST:(RAND:(INSERT_LIST_MAX))
ELSE
	;それ以外なら80%で主導度Ｕの値で補正した乱数
	;挿入中のキャラは50%で回避
	IF RAND:5
		FOR LOCAL:0, 0, CHARA_LIST_MAX
			SIF IS_INSERT_SINGLE(CHARA_LIST:(LOCAL:0)) >= 1 && !RAND:2
				CONTINUE
			行動候補:(LOCAL:0) = RAND:(1000 + ABL:(CHARA_LIST:(LOCAL:0)):主導度Ｕ / 2)
		NEXT
		RETURN CHARA_LIST:(FINDELEMENT(行動候補, MAXARRAY(行動候補, 0, CHARA_LIST_MAX), 0, CHARA_LIST_MAX))
	;20%の確率でランダム
	ELSE
		LOCAL:5 = CHARA_LIST:(RAND:CHARA_LIST_MAX)
	ENDIF
ENDIF
RETURN LOCAL:5
;-------------------------------------------------
;おまかせ時のターゲット選択
;-------------------------------------------------
@COM_AUTOSELECT_DECIDE_TARGET(プレイヤー)
#DIM プレイヤー
;行動可能なキャラの一覧
#DIM CHARA_LIST, 8

;行動可能なキャラの数
#DIM CHARA_LIST_MAX

;主人公と挿入状態にあるキャラの一覧
#DIM INSERT_LIST, 8

;主人公と挿入状態にあるキャラの数
#DIM INSERT_LIST_MAX

#DIM 返却候補
#DIM ループカウント

CHARA_LIST_MAX = 0
INSERT_LIST_MAX = 0

;●キャラの選択
;行動可能なキャラ、主人公と挿入状態にあるキャラの数を調べる　ただしプレイヤーは除く
FOR LOCAL:0, 0, CHARANUM
	IF IS_AUTOSELECT(LOCAL:0)
		CHARA_LIST:(CHARA_LIST_MAX) = LOCAL:0
		CHARA_LIST_MAX ++
		IF IS_INSERT_MUTUAL(MASTER, LOCAL:0) >= 1
			INSERT_LIST:(INSERT_LIST_MAX) = LOCAL:0
			INSERT_LIST_MAX ++
		ENDIF
	ENDIF
NEXT


返却候補 = MASTER
ループカウント = 0
;ターゲットの選択
;特殊勢力の男キャラ
IF IS_SP_COUNTRY_CHARA(プレイヤー) && IS_MALE(プレイヤー)
	;まんこがいたら（マスター含む）そいつら狙い
	;もしいなければマスターねらい
	返却候補 = MASTER
	FOR LOCAL:0, 0, CHARA_LIST_MAX
		IF VAGINA(CHARA_LIST:(LOCAL:0))
			WHILE 1
				ループカウント ++
				;マスターがまんこなら33％
				IF VAGINA(MASTER) && !RAND:3
					RETURN MASTER
				;マスターが処女なら100%
				ELSEIF VIRGIN(MASTER) && VAGINA(MASTER)
					RETURN MASTER
				ELSE
					返却候補 = CHARA_LIST:(RAND:CHARA_LIST_MAX)
					IF VAGINA(返却候補) && 返却候補 != プレイヤー
						RETURN 返却候補
					ENDIF
				ENDIF
				SIF ループカウント > 100
					BREAK
			WEND
		ENDIF
	NEXT
;ふたなる
ELSEIF PENIS(プレイヤー) && VAGINA(プレイヤー)
	;ランダム狙い
	;マスターは33%
	;処女でマスターにペニスがあるなら必ずマスター狙い（うっかり他人が破るの防止）
	返却候補 = MASTER
	WHILE 1
		ループカウント ++
		返却候補 = CHARA_LIST:(RAND:CHARA_LIST_MAX)
		IF VIRGIN(プレイヤー) && PENIS(MASTER)
			RETURN MASTER
		ENDIF
		SIF !RAND:3
			返却候補 = MASTER
		SIF 返却候補 != プレイヤー
			RETURN 返却候補
		SIF ループカウント > 100
			BREAK
	WEND
;チンポ
ELSEIF PENIS(プレイヤー)
	;まんこがいたら（マスター含む）そいつら狙い
	;もしいなければマスターねらい
	返却候補 = MASTER
	FOR LOCAL:0, 0, CHARA_LIST_MAX
		IF VAGINA(CHARA_LIST:(LOCAL:0))
			WHILE 1
				ループカウント ++
				;マスターがまんこなら33％
				IF VAGINA(MASTER) && !RAND:3
					RETURN MASTER
				;マスターが処女なら100%
				ELSEIF VIRGIN(MASTER) && VAGINA(MASTER)
					RETURN MASTER
				ELSE
					返却候補 = CHARA_LIST:(RAND:CHARA_LIST_MAX)
					IF VAGINA(返却候補) && 返却候補 != プレイヤー
						RETURN 返却候補
					ENDIF
				ENDIF
				SIF ループカウント > 100
					BREAK
			WEND
		ENDIF
	NEXT
;まんこ
ELSEIF VAGINA(プレイヤー)
	;ペニスがいたら（マスター含む）そいつらを狙う
	;ただし処女でマスターがチンポついてるならマスター狙い強制
	;もしいなければ0番、つまりマスターねらい
	返却候補 = MASTER
	FOR LOCAL:0, 0, CHARA_LIST_MAX
		IF PENIS(CHARA_LIST:(LOCAL:0))
			WHILE 1
				ループカウント ++
				;50%で強制マスター狙い
				IF !RAND:2
					RETURN MASTER
				ELSEIF VIRGIN(プレイヤー) && PENIS(MASTER)
					RETURN MASTER
				ELSE
					返却候補 = CHARA_LIST:(RAND:CHARA_LIST_MAX)
					IF PENIS(返却候補) && 返却候補 != プレイヤー
						RETURN 返却候補
					ENDIF
				ENDIF
				IF ループカウント > 100
					BREAK
				ENDIF
			WEND
		ENDIF
	NEXT
ENDIF

RETURN MASTER

;-------------------------------------------------
;慰安時のプレイヤー選択
;-------------------------------------------------
@COM_AUTOSELECT_DECIDE_PLAYER_IAN
;行動可能なキャラの一覧
#DIM CHARA_LIST, 8

;行動可能なキャラの数
#DIM CHARA_LIST_MAX

;主人公と挿入状態にあるキャラの一覧
#DIM INSERT_LIST, 8

;主人公と挿入状態にあるキャラの数
#DIM INSERT_LIST_MAX

#DIM 行動候補, 8

VARSET 行動候補, -1
CHARA_LIST_MAX = 0
INSERT_LIST_MAX = 0

;●キャラの選択
;行動可能なキャラ、主人公と挿入状態にあるキャラの数を調べる
FOR LOCAL:0, 0, CHARANUM
	IF IS_AUTOSELECT(LOCAL:0) && CFLAG:LOCAL:慰安モブ
		CHARA_LIST:(CHARA_LIST_MAX) = LOCAL:0
		CHARA_LIST_MAX ++
	ENDIF
NEXT

IF CHARA_LIST_MAX == 0
	PRINTFORML (行動可能な者が一人もいません。何もしないが選択されます)
	CALL CLEAR_MTAR()
	CALL CLEAR_MPLY()
	CALL ADD_MPLY(MASTER)
	LOCAL:10 = 292
	RETURN -1
ENDIF

;それ以外なら80%で主導度Ｕの値で補正した乱数
;挿入中のキャラは50%で回避
IF RAND:5
	FOR LOCAL:0, 0, CHARA_LIST_MAX
		SIF IS_INSERT_SINGLE(CHARA_LIST:(LOCAL:0)) >= 1 && !RAND:2
			CONTINUE
		行動候補:(LOCAL:0) = RAND:(1000 + ABL:(CHARA_LIST:(LOCAL:0)):主導度Ｕ / 2)
	NEXT
	RETURN CHARA_LIST:(FINDELEMENT(行動候補, MAXARRAY(行動候補, 0, CHARA_LIST_MAX), 0, CHARA_LIST_MAX))
;20%の確率でランダム
ELSE
	LOCAL:5 = CHARA_LIST:(RAND:CHARA_LIST_MAX)
ENDIF
RETURN LOCAL:5

;-------------------------------------------------
;慰安時のターゲット選択
;-------------------------------------------------
@COM_AUTOSELECT_DECIDE_TARGET_IAN(プレイヤー)
#DIM プレイヤー
;行動可能なキャラの一覧
#DIM CHARA_LIST, 8

;行動可能なキャラの数
#DIM CHARA_LIST_MAX

;主人公と挿入状態にあるキャラの一覧
#DIM INSERT_LIST, 8

;主人公と挿入状態にあるキャラの数
#DIM INSERT_LIST_MAX

#DIM 行動候補
#DIM ループカウント
CHARA_LIST_MAX = 0
INSERT_LIST_MAX = 0

;●キャラの選択
;行動可能なキャラ、主人公と挿入状態にあるキャラの数を調べる　ただしプレイヤーと慰安用モブは除く
FOR LOCAL:0, 0, CHARANUM
	IF CFLAG:LOCAL:調教参加フラグ && !CFLAG:LOCAL:慰安モブ
		CHARA_LIST:(CHARA_LIST_MAX) = LOCAL:0
		CHARA_LIST_MAX ++
	ENDIF
NEXT

IF CHARA_LIST_MAX == 0
	PRINTFORML (ターゲットにできる者が一人もいません。何もしないが選択されます)
	CALL CLEAR_MTAR()
	CALL CLEAR_MPLY()
	CALL ADD_MPLY(MASTER)
	LOCAL:10 = 292
	RETURN -1
ENDIF

;基本はランダム
行動候補 = CHARA_LIST:(RAND:CHARA_LIST_MAX)
ループカウント = 0

;ターゲットの選択
;特殊勢力の男キャラ
IF IS_SP_COUNTRY_CHARA(プレイヤー) && IS_MALE(プレイヤー)
	;まんこがいたらそいつら狙い
	;もしいなければランダム
	FOR LOCAL:0, 0, CHARA_LIST_MAX
		IF VAGINA(CHARA_LIST:(LOCAL:0))
			WHILE 1
				ループカウント ++
				行動候補 = CHARA_LIST:(RAND:CHARA_LIST_MAX)
				IF VAGINA(行動候補) && 行動候補 != プレイヤー
					RETURN 行動候補
				ENDIF
				IF ループカウント > 100
					RETURN 行動候補
				ENDIF
			WEND
		ENDIF
	NEXT
;ふたなり
ELSEIF PENIS(プレイヤー) && VAGINA(プレイヤー)
	;ランダム
	RETURN 行動候補
;チンポ
ELSEIF PENIS(プレイヤー)
	;まんこがいたらそいつら狙い
	;もしいなければランダム
	FOR LOCAL:0, 0, CHARA_LIST_MAX
		IF VAGINA(CHARA_LIST:(LOCAL:0))
			WHILE 1
				ループカウント ++
				行動候補 = CHARA_LIST:(RAND:CHARA_LIST_MAX)
				IF VAGINA(行動候補) && 行動候補 != プレイヤー
					RETURN 行動候補
				ENDIF
				IF ループカウント > 100
					RETURN 行動候補
				ENDIF
			WEND
		ENDIF
	NEXT
;まんこ
ELSEIF VAGINA(プレイヤー)
	;ちんぽがいたらそいつら狙い
	;もしいなければランダム
	FOR LOCAL:0, 0, CHARA_LIST_MAX
		IF PENIS(CHARA_LIST:(LOCAL:0))
			WHILE 1
				ループカウント ++
				行動候補 = CHARA_LIST:(RAND:CHARA_LIST_MAX)
				IF PENIS(行動候補) && 行動候補 != プレイヤー
					RETURN 行動候補
				ENDIF
				IF ループカウント > 100
					PRINTFORM %ANAME(行動候補)%
					RETURN 行動候補
				ENDIF
			WEND
		ENDIF
	NEXT
ENDIF

RETURN 行動候補


;-------------------------------------------------
;第三者の参加を決定する
;-------------------------------------------------
@AUTO_SET_THIRD_PERSON(主導者, 対象者, コマンド)
#DIM コマンド
#DIM 行動可能者
#DIM 主導者
#DIM 対象者
#DIM 今回候補
#DIM 対象

FOR LOCAL:0, 0, 5
	SIF !RAND:5
		CONTINUE
	;行動可能なキャラの数を調べる
	行動可能者 = 0
	FOR 対象, 0, CHARANUM
		IF IS_AUTOSELECT(対象) && !IS_MPLY(対象) && !IS_MTAR(対象)
			行動可能者 ++
		ENDIF
	NEXT

	;行動可能なキャラが1人以上存在する場合
	SIF 行動可能者 < 1
		BREAK

	;プレイヤー/ターゲットに追加するキャラの選択
	LOCAL:3 = RAND:(行動可能者)
	LOCAL:4 = 0
	今回候補 = -1
	FOR 対象, 0, CHARANUM
		IF IS_AUTOSELECT(対象) && !IS_MPLY(対象) && !IS_MTAR(対象)
			IF LOCAL:3 == LOCAL:4
				今回候補 = 対象
				BREAK
			ENDIF
			LOCAL:4 ++
		ENDIF
	NEXT
	SIF 今回候補 < -1
		CONTINUE
	;慰安する側なら、もう一人の慰安する側に合わせる
	IF FLAG:調教モード == 調教_慰安 && !CFLAG:今回候補:慰安モブ
		IF IS_MTAR(対象者)
			CALL ADD_MTAR(今回候補)
		ELSE
			CALL ADD_MPLY(今回候補)
		ENDIF
		GOTO DECIDED
	ENDIF
	;純粋な性別による判定とペニスがあるかの判定の二つを織り交ぜ、ふたなりの挙動に揺らぎをもたせる
	IF RAND:2
		IF IS_MALE(主導者) && IS_MALE(対象者) && IS_MALE(今回候補)
			LOCAL:30 = 0
		ELSEIF IS_MALE(主導者) && IS_MALE(対象者) && IS_FEMALE(今回候補)
			LOCAL:30 = 1
		ELSEIF IS_MALE(主導者) && IS_FEMALE(対象者) && IS_MALE(今回候補)
			LOCAL:30 = 2
		ELSEIF IS_FEMALE(主導者) && IS_MALE(対象者) && IS_MALE(今回候補)
			LOCAL:30 = 3
		ELSEIF IS_MALE(主導者) && IS_FEMALE(対象者) && IS_FEMALE(今回候補)
			LOCAL:30 = 4
		ELSEIF IS_FEMALE(主導者) && IS_MALE(対象者) && IS_FEMALE(今回候補)
			LOCAL:30 = 5
		ELSEIF IS_FEMALE(主導者) && IS_FEMALE(対象者) && IS_MALE(今回候補)
			LOCAL:30 = 6
		ELSEIF IS_FEMALE(主導者) && IS_FEMALE(対象者) && IS_FEMALE(今回候補)
			LOCAL:30 = 7
		ENDIF
	ELSE
		IF PENIS(主導者) && PENIS(対象者) && PENIS(今回候補)
			LOCAL:30 = 0
		ELSEIF PENIS(主導者) && PENIS(対象者) && VAGINA(今回候補)
			LOCAL:30 = 1
		ELSEIF PENIS(主導者) && VAGINA(対象者) && PENIS(今回候補)
			LOCAL:30 = 2
		ELSEIF VAGINA(主導者) && PENIS(対象者) && PENIS(今回候補)
			LOCAL:30 = 3
		ELSEIF PENIS(主導者) && VAGINA(対象者) && VAGINA(今回候補)
			LOCAL:30 = 4
		ELSEIF VAGINA(主導者) && PENIS(対象者) && VAGINA(今回候補)
			LOCAL:30 = 5
		ELSEIF VAGINA(主導者) && VAGINA(対象者) && PENIS(今回候補)
			LOCAL:30 = 6
		ELSEIF VAGINA(主導者) && VAGINA(対象者) && VAGINA(今回候補)
			LOCAL:30 = 7
		ENDIF
	ENDIF
	;プレイヤー／ターゲットを追加してコマンドが実行できるかチェック
	IF コマンド < 1000
		;愛撫系(胸愛撫など)
		IF 0 <= コマンド && コマンド <= 9
			SELECTCASE LOCAL:30
				;する側
				CASE 0, 2, 5
					CALL ADD_MPLY(今回候補)
				;される側
				CASE 3
					CALL ADD_MTAR(今回候補)
				;ランダム
				CASEELSE
					IF RAND:2
						CALL ADD_MPLY(今回候補)
					ELSE
						CALL ADD_MTAR(今回候補)
					ENDIF
			ENDSELECT
		;奉仕系
		ELSEIF 10 <= コマンド && コマンド <= 19
			SELECTCASE LOCAL:30
				;する側
				CASE 0, 2, 5
					CALL ADD_MPLY(今回候補)
				;される側
				CASE 3
					CALL ADD_MTAR(今回候補)
				;ランダム
				CASEELSE
					IF RAND:2
						CALL ADD_MPLY(今回候補)
					ELSE
						CALL ADD_MTAR(今回候補)
					ENDIF
			ENDSELECT
		;キス
		ELSEIF GROUPMATCH(コマンド, 20)
			SELECTCASE LOCAL:30
				;する側
				CASE 0, 2, 5
					CALL ADD_MPLY(今回候補)
				;される側
				CASE 3
					CALL ADD_MTAR(今回候補)
				;ランダム
				CASEELSE
					IF RAND:2
						CALL ADD_MPLY(今回候補)
					ELSE
						CALL ADD_MTAR(今回候補)
					ENDIF
			ENDSELECT
		;順番挿入
		ELSEIF GROUPMATCH(コマンド, 55, 56)
			;女なら問答無用でされる側
			SIF IS_FEMALE(今回候補)
				CALL ADD_MTAR(今回候補)
		;代わる代わる挿入
		ELSEIF GROUPMATCH(コマンド, 57, 58)
			SELECTCASE LOCAL:30
				;する側
				CASE 0, 2, 3, 6
					CALL ADD_MPLY(今回候補)
				;される側
				CASE 1, 4, 5, 7
					CALL ADD_MTAR(今回候補)
				;ランダム
				CASEELSE
					IF RAND:2
						CALL ADD_MPLY(今回候補)
					ELSE
						CALL ADD_MTAR(今回候補)
					ENDIF
			ENDSELECT
		;道具系
		ELSEIF 60 <= コマンド && コマンド <= 79
			SELECTCASE LOCAL:30
				;する側
				CASE 0, 2, 6
					CALL ADD_MPLY(今回候補)
				;される側
				CASE 3
					CALL ADD_MTAR(今回候補)
				;ランダム
				CASEELSE
					IF RAND:2
						CALL ADD_MPLY(今回候補)
					ELSE
						CALL ADD_MTAR(今回候補)
					ENDIF
			ENDSELECT
		;ＳＭ
		ELSEIF 80 <= コマンド && コマンド <= 99
			SELECTCASE LOCAL:30
				;する側
				CASE 0, 2, 5
					CALL ADD_MPLY(今回候補)
				;ランダム
				CASEELSE
					IF RAND:2
						CALL ADD_MPLY(今回候補)
					ELSE
						CALL ADD_MTAR(今回候補)
					ENDIF
			ENDSELECT
		;羞恥
		ELSEIF 100 <= コマンド && コマンド <= 129
			SELECTCASE LOCAL:30
				;する側
				CASE 0, 2, 5, 7
					CALL ADD_MPLY(今回候補)
				;される側
				CASE 3
					CALL ADD_MTAR(今回候補)
				;ランダム
				CASEELSE
					IF RAND:2
						CALL ADD_MPLY(今回候補)
					ELSE
						CALL ADD_MTAR(今回候補)
					ENDIF
			ENDSELECT
		ELSE
			CALL ADD_MPLY(今回候補)
		ENDIF
	ELSEIF コマンド < 2000
		;愛撫系(胸愛撫など)
		IF 1000 <= コマンド && コマンド <= 1009
			SELECTCASE LOCAL:30
				;する側
				CASE 1, 3
					CALL ADD_MPLY(今回候補)
				;される側
				CASE 0, 2, 5
					CALL ADD_MTAR(今回候補)
				;ランダム
				CASEELSE
					IF RAND:2
						CALL ADD_MPLY(今回候補)
					ELSE
						CALL ADD_MTAR(今回候補)
					ENDIF
			ENDSELECT
		;奉仕系
		ELSEIF 1010 <= コマンド && コマンド <= 1019
			SELECTCASE LOCAL:30
				;する側
				CASE 3
					CALL ADD_MPLY(今回候補)
				;される側
				CASE 0, 2, 5
					CALL ADD_MTAR(今回候補)
				;ランダム
				CASEELSE
					IF RAND:2
						CALL ADD_MPLY(今回候補)
					ELSE
						CALL ADD_MTAR(今回候補)
					ENDIF
			ENDSELECT
		;キス
		ELSEIF GROUPMATCH(コマンド, 1020)
			SELECTCASE LOCAL:30
				;する側
				CASE 3
					CALL ADD_MPLY(今回候補)
				;される側
				CASE 0, 2, 5
					CALL ADD_MTAR(今回候補)
				;ランダム
				CASEELSE
					IF RAND:2
						CALL ADD_MPLY(今回候補)
					ELSE
						CALL ADD_MTAR(今回候補)
					ENDIF
			ENDSELECT
		;順番挿入
		ELSEIF GROUPMATCH(コマンド, 1055, 1056)
			;女なら問答無用でされる側
			SIF IS_FEMALE(今回候補)
				CALL ADD_MTAR(今回候補)
		;代わる代わる挿入
		ELSEIF GROUPMATCH(コマンド, 1057, 1058)
			SELECTCASE LOCAL:30
				;する側
				CASE 3, 6
					CALL ADD_MPLY(今回候補)
				;される側
				CASE 0, 1, 2, 5
					CALL ADD_MTAR(今回候補)
				;ランダム
				CASEELSE
					IF RAND:2
						CALL ADD_MPLY(今回候補)
					ELSE
						CALL ADD_MTAR(今回候補)
					ENDIF
			ENDSELECT
		;道具系
		ELSEIF 1060 <= コマンド && コマンド <= 1079
			SELECTCASE LOCAL:30
				;する側
				CASE 3, 6
					CALL ADD_MPLY(今回候補)
				;される側
				CASE 0, 2, 5
					CALL ADD_MTAR(今回候補)
				;ランダム
				CASEELSE
					IF RAND:2
						CALL ADD_MPLY(今回候補)
					ELSE
						CALL ADD_MTAR(今回候補)
					ENDIF
			ENDSELECT
		;ＳＭ
		ELSEIF 1080 <= コマンド && コマンド <= 1099
			SELECTCASE LOCAL:30
				;する側
				CASE 3, 4, 6
					CALL ADD_MPLY(今回候補)
				;される側
				CASE 0, 2, 5 
					CALL ADD_MTAR(今回候補)
				;ランダム
				CASEELSE
					IF RAND:2
						CALL ADD_MPLY(今回候補)
					ELSE
						CALL ADD_MTAR(今回候補)
					ENDIF
			ENDSELECT
		;羞恥
		ELSEIF 1100 <= コマンド && コマンド <= 1129
			SELECTCASE LOCAL:30
				;する側
				CASE 3, 4
					CALL ADD_MPLY(今回候補)
				;される側
				CASE 0, 2, 5
					CALL ADD_MTAR(今回候補)
				;ランダム
				CASEELSE
					IF RAND:2
						CALL ADD_MPLY(今回候補)
					ELSE
						CALL ADD_MTAR(今回候補)
					ENDIF
			ENDSELECT
		ELSE
			CALL ADD_MPLY(今回候補)
		ENDIF
	ENDIF
	$DECIDED
	;コマンド判定フラグON
	COM_ENABLE = 1

	RESULT = 0
	TRYCALLFORM COM_ABLE{コマンド % 1000}
	IF !RESULT
		;ダメならプレイヤー／ターゲットを外す
		IF コマンド < 1000
			CALL DEL_MPLY(今回候補)
			CALL DEL_MTAR(今回候補)
		ELSEIF コマンド < 2000
			CALL DEL_MTAR(今回候補)
			CALL DEL_MPLY(今回候補)
		ELSE
		ENDIF

		;コマンド判定フラグOFF
		COM_ENABLE = 0
		BREAK
	ELSE
		;コマンド判定フラグOFF
		COM_ENABLE = 0
	ENDIF
NEXT
