;反乱の構文を独立させました
;RETURN 0 説得に成功 1 反乱した 2 何らかの理由で反乱を中止した
;離反者 独立するキャラ
;奪取都市数 奪う都市数 0なら所属勢力の1/3、1以上を指定してかつ奪取都市数固定が立っていなければ、最大でも離反元の半分に調整される
;奪取都市数固定 奪取都市数固定フラグ　立てる場合、事前にGET_OWN_CITYなどで離反元の所有都市数が奪取都市数を越えているか確認すること
@NPC_INDEPENDENCE(離反者, 奪取都市数 = 0, 奪取都市数固定 = 0)
#DIM 離反者
#DIM 奪取都市数
#DIM 奪取都市数固定
#DIM 離反元君主
#DIM 離反元勢力
#DIM 新勢力
#DIM 新勢力カラー
#DIM プレイヤー対応
#DIM CONST 対応_怒り = 3
#DIM CONST 対応_拒否 = 2
#DIM CONST 対応_受諾 = 1
#DIM CONST 対応_無関係 = 0

#DIM 武将数
#DIM 奪取武将数
#DIM 奪取武将

;捕虜、無所属ならRETURN
IF CFLAG:(離反者):捕虜先 || !IS_COUNTRY(CFLAG:(離反者):所属)
	RETURN -1
ENDIF

;離反元君主のキャラ番号
離反元君主 = GET_COUNTRY_BOSS(CFLAG:(離反者):所属)
;離反元国家の番号
離反元勢力 = CFLAG:(離反者):所属
;新しい勢力を取得
新勢力 = GET_NEW_COUNTRY()

;新勢力が作れない（すでにいっぱい）ならRETURN
SIF 新勢力 == -1
	RETURN -1

;離反元が都市数2以上であること
SIF GET_OWN_CITY(離反元勢力) < 2
	RETURN -1

;奪取都市数固定が立っていなくて、奪取都市数が離反元国家の所有都市数の半分以上なら、半分に調整する
SIF GET_OWN_CITY(離反元勢力) / 2 <= 奪取都市数 && !奪取都市数固定
	奪取都市数 = GET_OWN_CITY(離反元勢力) / 2

;奪取都市数が立っていない場合、所属勢力の1/3を持って行く（最低1)
SIF 奪取都市数 == 0
	奪取都市数 = MAX(GET_OWN_CITY(離反元勢力) / 3, 1)

;奪取都市数が離反元国家の所有都市数以上ならやめる
SIF GET_OWN_CITY(離反元勢力) <= 奪取都市数
	RETURN -1

;国家色は関数にて自動決定

CALL CHARA_DIPRO_COLOR(CSTR:(離反者):99)
新勢力カラー = RESULT

;色設定がなかったら髪の色
SIF 新勢力カラー == 0XFFFFFF
	新勢力カラー = TALENT:(離反者):髪色

;髪の色すら設定されてなければRETURN
SIF 新勢力カラー == 0
	RETURN -1

COUNTRY_COLOR:(新勢力) = 新勢力カラー

;プレイヤーの態度をプレイヤー対応に格納
プレイヤー対応 = 対応_無関係

;プレイヤーが離反者の所属国家の君主でなく、かつ離反者の同僚である
IF 離反元君主 != MASTER && CFLAG:MASTER:所属 == CFLAG:(離反者):所属
	CALL NPC_INDEPENDENCE_EVENT(離反者, 離反元君主, 新勢力)
	SIF RESULT == 0
		RETURN
	プレイヤー対応 = RESULT
ENDIF


CALL SINGLE_DRAWLINE
CALL COLORPRINT(@"%NAME_FORMAL(離反者)%が挙兵し、%NAME_FORMAL(離反元君主)%の勢力から独立しました！", カラー_警告, "W")

COUNTRY_BOSS:(新勢力) = GET_ID(離反者)
CALL CHANGE_COUNTRY(離反者, 新勢力, 1)
	;離反元勢力の都市の守将を解除
FOR LOCAL:0, 0, MAX_CITY
	IF CITY_OWNER:(LOCAL:0) == 離反元勢力
		CITY_COMMANDER:(LOCAL:0) = 0
	ENDIF
NEXT
;都市をかすめ取る
CALL STEAL_CITIES(離反元勢力, 新勢力, 奪取都市数)

;武将数をカウントする
武将数 = 0
FOR LOCAL:0, 0, CHARANUM
	;離反元所属でないとだめ
	SIF CFLAG:(LOCAL:0):所属 != 離反元勢力
		CONTINUE
	;捕虜ならだめ
	SIF CFLAG:(LOCAL:0):捕虜先
		CONTINUE
	;主人公、離反者、君主はだめ
	SIF GROUPMATCH(LOCAL:0, MASTER, 離反者, 離反元君主)
		CONTINUE
	;特殊キャラもダメ
	SIF IS_SP_CHARA(LOCAL:0)
		CONTINUE
	武将数 ++
NEXT

SIF 武将数 <= 0
	GOTO STEAL_COMMANDER_END

;25～50%の武将を奪う。最大10
奪取武将数 = MIN(武将数 * RAND(25, 50) / 100, 10)
CALL FISHER_YATES_SHAFFLE(CHARANUM)
FOR LOCAL, 0, CHARANUM
	SIF 奪取武将数 == 0
		BREAK
	奪取武将 = SHAFFLE_ARRAY:LOCAL
	;離反元所属でないとだめ
	SIF CFLAG:(奪取武将):所属 != 離反元勢力
		CONTINUE
	;捕虜ならだめ
	SIF CFLAG:(奪取武将):捕虜先
		CONTINUE
	;主人公、離反者、君主はだめ
	SIF GROUPMATCH(奪取武将, MASTER, 離反者, 離反元君主)
		CONTINUE
	;特殊キャラもダメ
	SIF IS_SP_CHARA(奪取武将)
		CONTINUE
	;プレイヤーがかかわる場合の陥落済みキャラの扱い
	IF (IS_LOVER(奪取武将) || IS_SLAVE(奪取武将)) && プレイヤー対応 != 対応_無関係
		;裏切る場合、陥落済みキャラはついてくる
		IF プレイヤー対応 == 対応_受諾
			CALL CHANGE_COUNTRY(奪取武将, 新勢力, 1)
			奪取武将数 --
		;怒らせた場合は拉致してくる
		ELSEIF プレイヤー対応 == 対応_怒り
			CALL CAPTURE(奪取武将, 新勢力)
			奪取武将数 --
		ENDIF
		;拒否した場合はなにもしてこない
	;1/2の確率で同調OR拉致
	ELSEIF RAND:2
		IF REL_LIKE:奪取武将:離反元君主 - REL_HATE:奪取武将:離反元君主 > 0
			CALL CAPTURE(奪取武将, 新勢力)
		ELSE
			CALL CHANGE_COUNTRY(奪取武将, 新勢力, 1)
		ENDIF
		奪取武将数 --
	ENDIF
NEXT

$STEAL_COMMANDER_END

;離反元勢力の部隊を解散
CALL CLEAR_ALL_UNIT(離反元勢力, 1)
;仲はまぁ、悪くもなりますわな
CALL CHANGE_RELATION_C_TO_C(離反元勢力, 新勢力, -200, 600)
CALL CHANGE_RELATION_C_TO_C(新勢力, 離反元勢力, -200, 600)

;反乱勢力の都市を表示
FOR LOCAL:0, 0, MAX_CITY
	IF CITY_OWNER:(LOCAL:0) == 新勢力
		PRINTFORML %GET_CITYNAME(LOCAL:0)%が%ANAME(離反者)%の支配下におかれました
	ENDIF
NEXT
;反乱勢力に流れた人材
FOR LOCAL:0, 0, CHARANUM
	IF CFLAG:(LOCAL:0):所属 == 新勢力 && LOCAL:0 != 離反者
		PRINTFORML %ANAME(LOCAL:0)%が%ANAME(離反者)%の下につきました
	ELSEIF CFLAG:(LOCAL:0):9 == 新勢力
		SETCOLOR カラー_警告
		PRINTFORML %ANAME(LOCAL:0)%が%ANAME(離反者)%に拉致されました
		RESETCOLOR
	ENDIF
NEXT


@NPC_INDEPENDENCE_EVENT(離反者, 離反元君主, 新勢力)
#DIM 離反者
#DIM 離反元君主
#DIM 新勢力
#DIM CONST 対応_怒り = 3
#DIM CONST 対応_拒否 = 2
#DIM CONST 対応_受諾 = 1
#DIM CONST 対応_無関係 = 0

;それなりに仲が良いと、一緒に来ないかと尋ねられる
;汎用化したので、セリフはそれっぽい地の文に置き換え
IF CFLAG:(離反者):好感度 >= 300
	CALL SINGLE_DRAWLINE
	PRINTFORML ある日、%ANAME(離反者)%に急に呼び出された
	PRINTFORMW 人払いをした彼女の部屋で、%ANAME(離反者)%に告げられる
	PRINTFORML
	PRINTFORML 自分は%ANAME(離反元君主)%から離反しようと考えている。%ANAME(MASTER)%は使えそうだし、是非とも連れて行きたい
	PRINTFORML いきなりの話だし、主君を裏切るわけだから迷うだろうが、すぐ返事が欲しい
	PRINTFORMW 答えるまで帰すわけにはいかない。%ANAME(MASTER)%が%ANAME(離反元君主)%に密告しないとも限らないからだ……
	PRINTFORML
	PRINTFORML えらいことを聞いてしまった。これは、返事をするまで帰れないだろう
	PRINTFORMW 今後の身の振り方に関わってくることだ、慎重に選ばなくては……
	CALL ASK_MULTI(@"%ANAME(離反者)%につく", @"%ANAME(離反元君主)%側に残る", "馬鹿なことはやめろと説得する")
	IF RESULT == 0
		CALL CHANGE_COUNTRY(MASTER, 新勢力, 1)
		PRINTFORML お前ならそう言ってくれると思っていた……%ANAME(離反者)%は凶悪な笑みをにやりと浮かべてみせた
		PRINTFORML いっちょやってやろう、%ANAME(離反者)%は%ANAME(MASTER)%と固い握手を交わした……
		PRINTFORMW なんだかえらいことに首を突っ込んでしまった気がする。大丈夫だろうか……
		RETURN 対応_受諾
	ELSEIF RESULT == 1
		PRINTFORMW %ANAME(離反元君主)%を裏切るわけにはいかない……そう告げると、%ANAME(離反者)%は露骨に失望した表情を浮かべた
		PRINTFORML それならとっとと出て行け、後悔するな、これから作る国は、お前の国などあっという間に食い尽くす、そのように告げられた
		PRINTFORML それっきり%ANAME(離反者)%はこちらに興味を失ったのか、そっぽを向いてしまった
		PRINTFORMW ここで%ANAME(MASTER)%に危害を加えるつもりはないようだが、次に会うときは敵同士になるだろう……
		PRINTL
		RETURN 対応_拒否
	ELSEIF RESULT == 2
		PRINTFORM バカなことはやめろ……
		;何らかのあなたに対する陥落素質があれば思いとどまる
		IF (IS_LOVER(離反者) || IS_SLAVE(離反者))
			PRINTFORMW %ANAME(MASTER)%が必死に説得すると、%ANAME(離反者)%はため息をついた
			PRINTFORML %ANAME(MASTER)%にそんなことを言われるとは思っていなかった
			PRINTFORML しかし、%ANAME(MASTER)%の言うことを断りたくはない。仕方がないから今回は我慢する
			PRINTFORMW その代わりに、自分を色々と満足させてくれると嬉しい……
			PRINTFORMW どうやら%ANAME(離反者)%は離反をあきらめてくれたようだ……
			RETURN
		;なければd100が現在の好感度の1/10より大きければキレる
		ELSEIF RAND:100 > CFLAG:(離反者):好感度 / 10
			PRINTFORMW %ANAME(MASTER)%が必死に説得すると、%ANAME(離反者)%は逆上した
			PRINTFORML なんでお前にそんなことを言われなくてはならないのか
			PRINTFORML そういうことなら%ANAME(MASTER)%は必要ない。自分が巻き起こす旋風に巻き込まれて消えてしまえばいい
			PRINTFORMW 出て行け、自分の前から消えろ……
			PRINTFORML そう言って怒りを収めることなく%ANAME(離反者)%はあなたを部屋から追い出した
			PRINTFORMW 次に%ANAME(離反者)%と出会うのは戦場か、それとも……
			PRINTL
			RETURN 対応_怒り
		;そうでなければ普通に別れる、なお台詞はコピペのままで終わらせたくなかったのでちょこちょこ変えてみた
		ELSE
			PRINTFORMW %ANAME(MASTER)%が必死に説得すると、%ANAME(離反者)%は嫌悪の表情を浮かべた
			PRINTFORML こっちにつくつもりがないなら、出て行ってくれ
			PRINTFORMW %ANAME(MASTER)%が%ANAME(離反元君主)%にご執心なのは分かった。今のうちにせいぜい乳繰り合っているがいい……
			PRINTFORMW 違う、そう反論しようとするよりも早く%ANAME(離反者)%は言葉を続けた
			PRINTFORMW すぐに自分の国が、色ボケしている%ANAME(離反元君主)%もろともお前たちを滅ぼすだろう……
			PRINTFORML 怒りの表情を隠さない%ANAME(離反者)%の姿を背に、%ANAME(MASTER)%は部屋から出て行った
			PRINTFORMW %ANAME(MASTER)%と刃を交えるとき、お互いどのような顔をしているのだろうか……
			PRINTL
			RETURN 対応_拒否
		ENDIF
	ENDIF
ENDIF
